<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XNPBK7CRGG"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XNPBK7CRGG');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONI Framework Visualization | 14-Layer Security Model</title>
    <meta name="description" content="3D visualization of the ONI 14-layer neural security framework. Interact with the complete silicon-to-biology security model in an immersive Three.js environment.">
    <meta property="og:title" content="ONI Framework Visualization | 14-Layer Security Model">
    <meta property="og:description" content="3D visualization of the ONI 14-layer neural security framework. Interact with the complete silicon-to-biology security model in an immersive Three.js environment.">
    <meta property="og:url" content="https://qinnovate.com/mindloft/visualizations/08-oni-framework-viz.html">
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0f1a;
            color: #c9d1d9;
            overflow: hidden;
            height: 100vh;
        }

        /* Header reveal bar */
        #header-reveal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 24px;
            z-index: 101;
            background: linear-gradient(180deg, rgba(13, 17, 23, 0.7) 0%, transparent 100%);
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        #header-reveal.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #header-reveal .reveal-tab {
            margin-top: 0;
            padding: 2px 16px 4px;
            background: rgba(33, 38, 45, 0.85);
            border: 1px solid #30363d;
            border-top: none;
            border-radius: 0 0 8px 8px;
            font-size: 10px;
            color: #8b949e;
            letter-spacing: 0.06em;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: color 0.2s, background 0.2s;
        }
        #header-reveal:hover .reveal-tab {
            color: #c9d1d9;
            background: rgba(33, 38, 45, 0.95);
        }

        /* Header */
        #header {
            padding: 16px 24px;
            border-bottom: 1px solid #21262d;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            transform: translateY(0);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #header.header-collapsed {
            transform: translateY(-100%);
        }
        .header-left .header-label {
            font-size: 10px;
            letter-spacing: 0.2em;
            color: #58a6ff;
            margin-bottom: 2px;
        }
        .header-left h1 {
            font-size: 22px;
            font-weight: 600;
            color: #f0f6fc;
            margin: 0;
        }
        .header-left .header-sub {
            font-size: 12px;
            color: #8b949e;
            margin-top: 1px;
        }
        .header-right {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .header-stat {
            text-align: center;
        }
        .header-stat .stat-val {
            font-size: 20px;
            font-weight: 600;
        }
        .header-stat .stat-label {
            font-size: 9px;
            color: #8b949e;
            letter-spacing: 0.1em;
        }
        .header-divider {
            width: 1px;
            height: 32px;
            background: #21262d;
        }
        .header-back {
            color: #58a6ff;
            text-decoration: none;
            font-size: 12px;
            padding: 6px 12px;
            border: 1px solid #21262d;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .header-back:hover {
            background: rgba(88, 166, 255, 0.1);
            border-color: #58a6ff;
        }

        /* 3D Container */
        #oni-3d-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }
        #oni-3d-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* Zone Labels */
        .oni3d-label {
            position: absolute;
            font-size: 10px;
            letter-spacing: 0.15em;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.8s ease;
            pointer-events: none;
            text-shadow: 0 1px 8px rgba(0,0,0,0.8);
            z-index: 10;
        }
        .oni3d-label.visible { opacity: 1; }
        .oni3d-label-silicon {
            top: 18%;
            right: 22%;
            color: #58a6ff;
        }
        .oni3d-label-gateway {
            top: 50%;
            right: 16%;
            transform: translateY(-50%);
            color: #f0883e;
            font-weight: 600;
        }
        .oni3d-label-biology {
            bottom: 22%;
            right: 22%;
            color: #3fb950;
        }

        /* Layer Sidebar */
        #layer-sidebar {
            position: fixed;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 20;
            display: flex;
            flex-direction: column;
            gap: 3px;
            padding: 10px 6px;
            background: rgba(13, 17, 23, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 12px;
            border: 1px solid rgba(33, 38, 45, 0.6);
        }
        .sidebar-zone-label {
            font-size: 8px;
            letter-spacing: 0.15em;
            text-align: center;
            padding: 4px 0 2px;
            font-weight: 600;
        }
        .sidebar-zone-label.bio { color: #3fb950; }
        .sidebar-zone-label.gw { color: #f0883e; }
        .sidebar-zone-label.si { color: #58a6ff; }
        .layer-badge {
            width: 36px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
            background: rgba(33, 38, 45, 0.5);
            color: #8b949e;
        }
        .layer-badge:hover {
            background: rgba(48, 54, 61, 0.8);
            color: #c9d1d9;
        }
        .layer-badge.active {
            border-color: #ffffff;
            color: #f0f6fc;
        }
        .layer-badge.silicon { border-color: transparent; }
        .layer-badge.silicon:hover, .layer-badge.silicon.active { background: rgba(88, 166, 255, 0.2); }
        .layer-badge.silicon.active { border-color: #58a6ff; box-shadow: 0 0 8px rgba(88, 166, 255, 0.3); }
        .layer-badge.gateway { border-color: transparent; }
        .layer-badge.gateway:hover, .layer-badge.gateway.active { background: rgba(240, 136, 62, 0.25); }
        .layer-badge.gateway.active { border-color: #f0883e; box-shadow: 0 0 10px rgba(240, 136, 62, 0.4); }
        .layer-badge.biology { border-color: transparent; }
        .layer-badge.biology:hover, .layer-badge.biology.active { background: rgba(63, 185, 80, 0.2); }
        .layer-badge.biology.active { border-color: #3fb950; box-shadow: 0 0 8px rgba(63, 185, 80, 0.3); }

        /* Detail Panel */
        #detail-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 420px;
            max-width: 92vw;
            background: rgba(13, 17, 23, 0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-left: 1px solid #21262d;
            z-index: 30;
            transform: translateX(0);
            transition: transform 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
        }
        #detail-panel.hidden {
            transform: translateX(100%);
            pointer-events: none;
        }
        #detail-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(48, 54, 61, 0.5);
            border: 1px solid #30363d;
            color: #8b949e;
            font-size: 20px;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            transition: all 0.15s;
        }
        #detail-close:hover {
            background: rgba(248, 81, 73, 0.15);
            border-color: #f85149;
            color: #f85149;
        }
        #detail-content {
            padding: 20px;
            padding-top: 56px;
        }
        .detail-header {
            font-size: 11px;
            letter-spacing: 0.15em;
            color: #8b949e;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #21262d;
        }
        .detail-header .layer-name {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            letter-spacing: 0;
            display: block;
            margin-top: 6px;
        }
        .detail-card {
            padding: 14px;
            background: rgba(22, 27, 34, 0.8);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .detail-card-label {
            font-size: 9px;
            letter-spacing: 0.15em;
            color: #8b949e;
            margin-bottom: 6px;
        }
        .detail-card-text {
            font-size: 13px;
            color: #c9d1d9;
            line-height: 1.5;
        }
        .detail-card-accent {
            border-left: 3px solid #8b949e;
        }
        .attacks-header {
            font-size: 11px;
            letter-spacing: 0.15em;
            color: #f85149;
            margin: 20px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .attack-card {
            padding: 12px 14px;
            background: rgba(13, 17, 23, 0.8);
            border-radius: 8px;
            border: 1px solid #21262d;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .attack-card:hover {
            background: rgba(33, 38, 45, 0.6);
        }
        .attack-card.expanded {
            border-color: #30363d;
            background: rgba(33, 38, 45, 0.5);
        }
        .attack-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
        }
        .attack-id {
            font-size: 10px;
            color: #8b949e;
            margin-right: 6px;
        }
        .attack-name {
            font-size: 13px;
            font-weight: 500;
            color: #f0f6fc;
        }
        .attack-tactic {
            font-size: 9px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .attack-desc {
            font-size: 12px;
            color: #8b949e;
            line-height: 1.5;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #21262d;
            display: none;
        }
        .attack-card.expanded .attack-desc {
            display: block;
        }

        /* Signal Log */
        #oni3d-signal-log {
            position: fixed;
            bottom: 60px;
            left: 60px;
            z-index: 15;
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-width: 380px;
        }
        .oni3d-log-entry {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 4px 8px;
            border-left: 2px solid;
            background: rgba(13, 17, 23, 0.7);
            backdrop-filter: blur(4px);
            border-radius: 0 4px 4px 0;
            transition: opacity 0.6s;
        }
        .oni3d-log-entry.fade { opacity: 0; }

        /* Signal Legend */
        #signal-legend {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 15;
            display: flex;
            gap: 16px;
            padding: 6px 16px;
            background: rgba(13, 17, 23, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            border: 1px solid rgba(33, 38, 45, 0.5);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #8b949e;
        }
        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .legend-dot.blue { background: #60a5fa; box-shadow: 0 0 4px rgba(96,165,250,0.5); }
        .legend-dot.red { background: #f87171; box-shadow: 0 0 4px rgba(248,113,113,0.5); }
        .legend-dot.green { background: #4ade80; box-shadow: 0 0 4px rgba(74,222,128,0.5); }

        /* Explainer */
        #oni3d-explainer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 40;
            background: rgba(13, 17, 23, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 20px 28px;
            text-align: center;
            font-size: 14px;
            color: #c9d1d9;
            max-width: 360px;
            transition: opacity 0.4s ease;
        }
        #oni3d-explainer.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #oni3d-explainer p {
            margin: 0 0 12px;
            line-height: 1.5;
        }
        #oni3d-explainer .hint {
            font-size: 11px;
            color: #8b949e;
        }
        #oni3d-explainer-close {
            background: rgba(88, 166, 255, 0.15);
            border: 1px solid #58a6ff;
            color: #58a6ff;
            padding: 6px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-top: 12px;
            transition: all 0.15s;
        }
        #oni3d-explainer-close:hover {
            background: rgba(88, 166, 255, 0.25);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            background: rgba(33, 38, 45, 0.6);
            border-radius: 8px;
            padding: 3px;
            border: 1px solid #21262d;
        }
        .view-btn {
            background: transparent;
            border: none;
            color: #8b949e;
            font-size: 12px;
            font-family: inherit;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 500;
            white-space: nowrap;
            text-decoration: none;
        }
        .view-btn:hover {
            color: #c9d1d9;
        }
        .view-btn.active {
            background: rgba(88, 166, 255, 0.15);
            color: #58a6ff;
        }

        /* View visibility */
        body.view-explorer #oni-3d-container,
        body.view-explorer #layer-sidebar,
        body.view-explorer #detail-panel,
        body.view-explorer #oni3d-signal-log,
        body.view-explorer #signal-legend,
        body.view-explorer #oni3d-explainer,
        body.view-explorer #footer,
        body.view-explorer #control-panel-fab {
            display: none !important;
        }
        body.view-3d #explorer-container {
            display: none !important;
        }

        /* Explorer View */
        #explorer-container {
            display: none;
            position: relative;
            z-index: 1;
        }
        body.view-explorer #explorer-container {
            display: block;
        }
        body.view-explorer {
            overflow: auto;
            height: auto;
        }
        #explorer-wave-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
        }
        body.view-explorer #explorer-wave-canvas {
            display: block;
        }
        body.view-3d #explorer-wave-canvas {
            display: none;
        }

        /* Landing Screen */
        #landing-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 200;
            background: #0a0f1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        #landing-screen.hidden {
            display: none;
        }
        .landing-label {
            font-size: 10px;
            letter-spacing: 0.25em;
            color: #58a6ff;
            margin-bottom: 6px;
        }
        .landing-title {
            font-size: 28px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 4px;
        }
        .landing-sub {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 36px;
        }
        .landing-prompt {
            font-size: 13px;
            color: #c9d1d9;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .landing-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            max-width: 860px;
            width: 100%;
        }
        .landing-card {
            background: rgba(22, 27, 34, 0.8);
            border: 1px solid #21262d;
            border-radius: 16px;
            padding: 32px 28px;
            cursor: pointer;
            transition: all 0.25s ease;
            text-align: center;
        }
        .landing-card:hover {
            background: rgba(22, 27, 34, 1);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        .landing-card-primary {
            border-color: rgba(240, 136, 62, 0.3);
            position: relative;
        }
        .landing-card-primary::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: 16px;
            border: 1px solid rgba(240, 136, 62, 0.15);
            animation: pulse-card 3s ease-in-out infinite;
            pointer-events: none;
        }
        @keyframes pulse-card {
            0%, 100% { border-color: rgba(240, 136, 62, 0.15); box-shadow: 0 0 0 rgba(240,136,62,0); }
            50% { border-color: rgba(240, 136, 62, 0.4); box-shadow: 0 0 20px rgba(240,136,62,0.08); }
        }
        .landing-card:first-child:hover {
            border-color: #58a6ff;
            box-shadow: 0 12px 40px rgba(88, 166, 255, 0.15);
        }
        .landing-card:nth-child(2):hover {
            border-color: #3fb950;
            box-shadow: 0 12px 40px rgba(63, 185, 80, 0.15);
        }
        .landing-card-primary:hover {
            border-color: #f0883e;
            box-shadow: 0 12px 40px rgba(240, 136, 62, 0.15);
        }
        .landing-card-sub {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 12px;
            letter-spacing: 0.03em;
        }
        .landing-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
        }
        .landing-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #f0f6fc;
            margin-bottom: 8px;
        }
        .landing-card p {
            font-size: 13px;
            color: #8b949e;
            line-height: 1.6;
            margin: 0;
        }
        .landing-card .landing-hint {
            display: inline-block;
            margin-top: 16px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.05em;
        }
        .landing-card:first-child .landing-hint {
            color: #58a6ff;
        }
        .landing-card:nth-child(2) .landing-hint {
            color: #3fb950;
        }
        .landing-card-primary .landing-hint {
            color: #f0883e;
        }
        .landing-footer {
            margin-top: 32px;
            font-size: 11px;
            color: #484f58;
        }

        /* Hide everything when landing is visible */
        body.view-landing #header,
        body.view-landing #header-reveal,
        body.view-landing #oni-3d-container,
        body.view-landing #layer-sidebar,
        body.view-landing #detail-panel,
        body.view-landing #oni3d-signal-log,
        body.view-landing #signal-legend,
        body.view-landing #oni3d-explainer,
        body.view-landing #footer,
        body.view-landing #explorer-container,
        body.view-landing #explorer-wave-canvas,
        body.view-landing #control-panel-fab {
            display: none !important;
        }

        @media (max-width: 768px) {
            .landing-options {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            .landing-title { font-size: 22px; }
            .landing-card { padding: 24px 20px; }
            .landing-card-icon { font-size: 36px; }
        }

        /* Footer */
        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 8px 24px;
            text-align: center;
            font-size: 11px;
            color: #484f58;
            z-index: 5;
            pointer-events: none;
        }
        #footer span { color: #f0883e; }

        /* Mobile */
        @media (max-width: 768px) {
            #header {
                padding: 10px 16px;
            }
            .header-left h1 { font-size: 18px; }
            .header-right .header-stat { display: none; }
            .header-right .header-divider { display: none; }

            #layer-sidebar {
                left: 50%;
                top: auto;
                bottom: 44px;
                transform: translateX(-50%);
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                max-width: 95vw;
                padding: 6px 8px;
                gap: 2px;
            }
            .sidebar-zone-label {
                width: 100%;
                padding: 2px 0;
                font-size: 7px;
            }
            .layer-badge {
                width: 28px;
                height: 22px;
                font-size: 9px;
            }

            #detail-panel {
                width: 100vw;
                max-width: 100vw;
                height: 60vh;
                top: auto;
                bottom: 0;
                border-left: none;
                border-top: 1px solid #21262d;
                border-radius: 16px 16px 0 0;
                transform: translateY(0);
            }
            #detail-panel.hidden {
                transform: translateY(100%);
            }

            .oni3d-label { font-size: 8px; }
            .oni3d-label-silicon { top: 15%; right: 8%; }
            .oni3d-label-gateway { right: 5%; }
            .oni3d-label-biology { bottom: 35%; right: 8%; }

            #oni3d-signal-log {
                bottom: 110px;
                left: 8px;
                max-width: 240px;
            }
            .oni3d-log-entry { font-size: 9px; }

            #signal-legend {
                bottom: 42px;
                right: 8px;
                left: auto;
                transform: none;
                gap: 8px;
                padding: 4px 10px;
            }
            .legend-item { font-size: 8px; }

            #footer { display: none; }

            .view-toggle {
                order: -1;
                width: 100%;
                justify-content: center;
            }

            body.view-explorer #explorer-container main {
                grid-template-columns: 1fr !important;
                padding: 16px !important;
            }
        }

        /* Control Panel */
        #control-panel {
            position: fixed;
            right: 12px;
            top: 80px;
            width: 272px;
            z-index: 25;
            background: rgba(13, 17, 23, 0.88);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #21262d;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .cp-section-label {
            font-size: 9px;
            letter-spacing: 0.15em;
            color: #8b949e;
            margin-bottom: 6px;
        }
        .cp-row {
            display: flex;
            gap: 6px;
        }
        .cp-btn {
            flex: 1;
            padding: 7px 4px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: rgba(33, 38, 45, 0.6);
            color: #c9d1d9;
            font-family: inherit;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
        }
        .cp-btn:hover { background: rgba(48, 54, 61, 0.8); color: #f0f6fc; }
        .cp-btn.active { border-color: #58a6ff; color: #58a6ff; background: rgba(88,166,255,0.12); }
        .cp-btn.blue { border-color: #58a6ff; }
        .cp-btn.blue:hover { background: rgba(88,166,255,0.2); color: #58a6ff; }
        .cp-btn.red { border-color: #f85149; }
        .cp-btn.red:hover { background: rgba(248,81,73,0.2); color: #f85149; }
        .cp-btn.green { border-color: #3fb950; }
        .cp-btn.green:hover { background: rgba(63,185,80,0.2); color: #3fb950; }
        .cp-btn.amber { border-color: #f0883e; }
        .cp-btn.amber:hover { background: rgba(240,136,62,0.2); color: #f0883e; }
        .cp-select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #161b22;
            color: #c9d1d9;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
        }
        .cp-select optgroup { color: #8b949e; font-style: normal; }
        .cp-select option { color: #c9d1d9; background: #161b22; }
        .cp-slider-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        .cp-slider-label {
            font-size: 10px;
            color: #8b949e;
            min-width: 20px;
        }
        .cp-slider-val {
            font-size: 10px;
            color: #c9d1d9;
            min-width: 30px;
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .cp-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: #21262d;
            outline: none;
        }
        .cp-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #58a6ff;
            cursor: pointer;
        }
        .cp-checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: #8b949e;
            cursor: pointer;
        }
        .cp-checkbox-row input { cursor: pointer; }
        .cp-tuner-toggle {
            font-size: 10px;
            color: #58a6ff;
            cursor: pointer;
            text-align: right;
            margin-top: -4px;
        }
        .cp-tuner-body { display: none; }
        .cp-tuner-body.open { display: block; }

        /* L8 Inspection Panel */
        #l8-inspection {
            position: fixed;
            right: 12px;
            bottom: 50px;
            width: 272px;
            z-index: 25;
            background: rgba(13, 17, 23, 0.92);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(240,136,62,0.3);
            border-radius: 12px;
            padding: 16px;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s, transform 0.4s;
            pointer-events: none;
        }
        #l8-inspection.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .l8-title {
            font-size: 10px;
            letter-spacing: 0.15em;
            color: #f0883e;
            margin-bottom: 10px;
        }
        .l8-gauge-wrap {
            text-align: center;
            margin-bottom: 10px;
        }
        .l8-cs-value {
            font-size: 22px;
            font-weight: 600;
            color: #f0f6fc;
            text-align: center;
            margin-bottom: 6px;
        }
        .l8-decision {
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.1em;
            padding: 6px 0;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        .l8-decision.accept { color: #3fb950; background: rgba(63,185,80,0.12); }
        .l8-decision.accept-flag { color: #f0883e; background: rgba(240,136,62,0.12); }
        .l8-decision.reject { color: #f85149; background: rgba(248,81,73,0.12); }
        .l8-var-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }
        .l8-var-label {
            font-size: 9px;
            color: #8b949e;
            min-width: 18px;
        }
        .l8-var-track {
            flex: 1;
            height: 4px;
            background: #21262d;
            border-radius: 2px;
            overflow: hidden;
        }
        .l8-var-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        .l8-var-val {
            font-size: 9px;
            color: #c9d1d9;
            min-width: 28px;
            text-align: right;
            font-family: 'Courier New', monospace;
        }
        .l8-narrative {
            font-size: 11px;
            color: #8b949e;
            line-height: 1.4;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #21262d;
        }

        /* Scenario Bar */
        #scenario-bar {
            position: fixed;
            top: 80px;
            transition: top 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            left: 0;
            right: 0;
            min-height: 48px;
            background: rgba(13, 17, 23, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid #21262d;
            z-index: 99;
            display: none;
            align-items: center;
            padding: 8px 24px;
            gap: 16px;
        }
        #scenario-bar.active { display: flex; }
        .scenario-dots {
            display: flex;
            gap: 6px;
        }
        .scenario-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #21262d;
            transition: background 0.3s;
        }
        .scenario-dot.done { background: #3fb950; }
        .scenario-dot.current { background: #58a6ff; box-shadow: 0 0 6px rgba(88,166,255,0.5); }
        .scenario-text {
            flex: 1;
        }
        .scenario-title {
            font-size: 13px;
            font-weight: 600;
            color: #f0f6fc;
        }
        .scenario-desc {
            font-size: 12px;
            color: #8b949e;
            line-height: 1.5;
        }
        .scenario-btns {
            display: flex;
            gap: 8px;
        }
        .scenario-btns button {
            padding: 5px 14px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: rgba(33,38,45,0.6);
            color: #c9d1d9;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .scenario-btns button:hover { background: rgba(48,54,61,0.8); color: #f0f6fc; }
        .scenario-btns .primary { border-color: #58a6ff; color: #58a6ff; }
        .scenario-btns .primary:hover { background: rgba(88,166,255,0.15); }
        .scenario-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            width: 0%;
            background: #58a6ff;
            border-radius: 0 1px 1px 0;
        }

        /* Hide control panel during guided tour */
        body.scenario-active #control-panel { display: none !important; }

        /* Tour annotation overlay */
        .tour-annotation {
            position: fixed;
            z-index: 35;
            background: rgba(13, 17, 23, 0.92);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 12px;
            color: #c9d1d9;
            max-width: 240px;
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .tour-annotation.hidden {
            opacity: 0;
            transform: translateY(8px);
            pointer-events: none;
        }
        .annotation-label {
            font-size: 9px;
            letter-spacing: 0.15em;
            color: #58a6ff;
            margin-bottom: 4px;
            font-weight: 600;
        }

        /* Hide new panels in explorer/landing views */
        body.view-explorer #control-panel,
        body.view-explorer #l8-inspection,
        body.view-explorer #scenario-bar,
        body.view-landing #control-panel,
        body.view-landing #l8-inspection,
        body.view-landing #scenario-bar {
            display: none !important;
        }

        /* Amber legend dot */
        .legend-dot.amber { background: #f0883e; box-shadow: 0 0 4px rgba(240,136,62,0.5); }

        /* Mobile control panel */
        @media (max-width: 768px) {
            #control-panel {
                position: fixed;
                right: 0;
                left: 0;
                top: auto;
                bottom: 0;
                width: 100%;
                max-height: 50vh;
                border-radius: 16px 16px 0 0;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 35;
            }
            #control-panel.mobile-open {
                transform: translateY(0);
            }
            #control-panel-fab {
                display: flex !important;
            }
            #l8-inspection {
                right: 50%;
                transform: translateX(50%) translateY(10px);
                bottom: auto;
                top: 80px;
                width: auto;
                min-width: 200px;
                padding: 10px 16px;
            }
            #l8-inspection.visible {
                transform: translateX(50%) translateY(0);
            }
            #scenario-bar {
                top: auto;
                bottom: 0;
                height: auto;
                padding: 10px 16px;
                flex-wrap: wrap;
            }
        }

        /* Control panel FAB (mobile) */
        #control-panel-fab {
            display: none;
            position: fixed;
            bottom: 60px;
            right: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(88,166,255,0.2);
            border: 1px solid #58a6ff;
            color: #58a6ff;
            font-size: 22px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 30;
            transition: all 0.2s;
        }
        #control-panel-fab:hover { background: rgba(88,166,255,0.3); }
    </style>
</head>
<body class="view-landing">

    <!-- Landing Screen -->
    <div id="landing-screen">
        <div class="landing-label">NEUROSECURITY RESEARCH</div>
        <div class="landing-title">ONI Framework</div>
        <div class="landing-sub">What happens when brain-computer interfaces have no security standard?</div>
        <div class="landing-options">
            <div class="landing-card" onclick="window.location.href='02-oni-layer-explorer.html'">
                <span class="landing-card-icon">&#128196;</span>
                <h3>Layer Overview</h3>
                <p>The 14-layer model explained &mdash; function, capacity, attack surfaces, and defenses for each layer.</p>
                <span class="landing-hint">Read the Layers &rarr;</span>
            </div>
            <div class="landing-card" onclick="launchView('explorer')">
                <span class="landing-card-icon">&#128203;</span>
                <h3>Interactive Explorer</h3>
                <p>All 14 layers with 46 threat signatures, attack patterns, and defense mappings &mdash; filterable and searchable.</p>
                <span class="landing-hint">Explore Layers &rarr;</span>
            </div>
            <div class="landing-card landing-card-primary" onclick="launchScenario()">
                <span class="landing-card-icon">&#127912;</span>
                <h3>3D Signal Simulator</h3>
                <div class="landing-card-sub">2-minute interactive walkthrough</div>
                <p>Watch signals travel from silicon to brain, see the firewall inspect them in real-time, and discover the attack that bypasses it.</p>
                <span class="landing-hint">Start the Experience &rarr;</span>
            </div>
        </div>
        <div class="landing-footer">You can switch views anytime from the header</div>
    </div>

    <!-- Header reveal bar -->
    <div id="header-reveal" onclick="showHeader()">
        <span class="reveal-tab">&#9662; Menu</span>
    </div>

    <!-- Header -->
    <header id="header">
        <div class="header-left">
            <div class="header-label">NEUROSECURITY & ETHICS STANDARD</div>
            <h1>ONI Framework</h1>
            <div class="header-sub">The OSI of Mind &mdash; 14 Layer Security Model</div>
        </div>
        <div class="header-right">
            <div class="view-toggle">
                <a class="view-btn" href="02-oni-layer-explorer.html">Layer Overview</a>
                <button class="view-btn active" data-view="3d" onclick="switchView('3d')">3D Simulator</button>
                <button class="view-btn" data-view="explorer" onclick="switchView('explorer')">Interactive Explorer</button>
            </div>
            <div class="header-divider"></div>
            <div class="header-stat">
                <div class="stat-val" style="color: #58a6ff">14</div>
                <div class="stat-label">LAYERS</div>
            </div>
            <div class="header-divider"></div>
            <div class="header-stat">
                <div class="stat-val" style="color: #f85149">46</div>
                <div class="stat-label">THREAT SIGNATURES</div>
            </div>
            <div class="header-divider"></div>
            <a href="../" class="header-back">&larr; Back to ONI</a>
        </div>
    </header>

    <!-- 3D Container -->
    <div id="oni-3d-container">
        <div class="oni3d-label oni3d-label-silicon">L1-L7 Silicon</div>
        <div class="oni3d-label oni3d-label-gateway">L8 Neural Gateway</div>
        <div class="oni3d-label oni3d-label-biology">L9-L14 Biology</div>
    </div>

    <!-- Layer Sidebar -->
    <div id="layer-sidebar"></div>

    <!-- Detail Panel -->
    <div id="detail-panel" class="hidden">
        <button id="detail-close">&times;</button>
        <div id="detail-content"></div>
    </div>

    <!-- Signal Log -->
    <div id="oni3d-signal-log"></div>

    <!-- Signal Legend -->
    <div id="signal-legend">
        <span class="legend-item"><span class="legend-dot blue"></span> Normal</span>
        <span class="legend-item"><span class="legend-dot red"></span> Threat</span>
        <span class="legend-item"><span class="legend-dot green"></span> Stimulation</span>
        <span class="legend-item"><span class="legend-dot amber"></span> Attack</span>
    </div>

    <!-- Explainer Popup -->
    <div id="oni3d-explainer">
        <p>Click any shell to select a layer and inject a signal.</p>
        <p class="hint">Watch how wavefronts propagate through the 14-layer security model.<br>Threats are blocked at the L8 Neural Gateway.</p>
        <button id="oni3d-explainer-close" onclick="document.getElementById('oni3d-explainer').classList.add('hidden')">Got it</button>
    </div>

    <!-- Control Panel -->
    <div id="control-panel">
        <div>
            <div class="cp-section-label">SIGNAL DIRECTION</div>
            <div class="cp-row">
                <button class="cp-btn active" id="cp-dir-write" onclick="setDirection('write')">WRITE (L1&rarr;L14)</button>
                <button class="cp-btn" id="cp-dir-read" onclick="setDirection('read')">READ (L14&rarr;L1)</button>
            </div>
            <div style="font-size:9px;color:#484f58;margin-top:4px;line-height:1.3">WRITE = device&rarr;brain &nbsp;|&nbsp; READ = brain&rarr;device</div>
        </div>
        <div>
            <div class="cp-section-label">QUICK INJECT</div>
            <div class="cp-row">
                <button class="cp-btn blue" onclick="injectQuick('normal')"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#60a5fa;margin-right:4px;vertical-align:middle"></span>Normal</button>
                <button class="cp-btn red" onclick="injectQuick('threat')"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#f87171;margin-right:4px;vertical-align:middle"></span>Threat</button>
                <button class="cp-btn green" onclick="injectQuick('stimulation')"><span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:#4ade80;margin-right:4px;vertical-align:middle"></span>Stim</button>
            </div>
        </div>
        <div>
            <div class="cp-section-label">SCENARIO PRESETS</div>
            <div class="cp-row">
                <button class="cp-btn" onclick="runPreset('stealth')" title="T7.3 + T14.4 — both pass the firewall">Stealth</button>
                <button class="cp-btn" onclick="runPreset('brute')" title="T4.1 + T9.1 — both rejected hard">Brute Force</button>
                <button class="cp-btn" onclick="runPreset('spoof')" title="T8.3 + T12.4 — one passes, one flagged">Spoofing</button>
            </div>
        </div>
        <div>
            <div class="cp-section-label">ATTACK INJECTION <span style="font-weight:400;color:#484f58">(46 attacks)</span></div>
            <select id="cp-attack-select" class="cp-select">
                <option value="">-- Select an attack --</option>
            </select>
            <button class="cp-btn amber" style="margin-top:6px;width:100%" onclick="injectAttack()">Launch Attack</button>
        </div>
        <div>
            <div class="cp-tuner-toggle" onclick="toggleTuner()">Variance Tuner &#9660;</div>
            <div id="cp-tuner-body" class="cp-tuner-body">
                <div class="cp-slider-row">
                    <span class="cp-slider-label" style="color:#60a5fa">&sigma;&sup2;&phi;</span>
                    <input type="range" class="cp-slider" id="cp-phase" min="0" max="200" value="5" oninput="updateSliderVal(this,'cp-phase-val')">
                    <span class="cp-slider-val" id="cp-phase-val">0.05</span>
                </div>
                <div class="cp-slider-row">
                    <span class="cp-slider-label" style="color:#f0883e">&sigma;&sup2;&tau;</span>
                    <input type="range" class="cp-slider" id="cp-transport" min="0" max="200" value="8" oninput="updateSliderVal(this,'cp-transport-val')">
                    <span class="cp-slider-val" id="cp-transport-val">0.08</span>
                </div>
                <div class="cp-slider-row">
                    <span class="cp-slider-label" style="color:#3fb950">&sigma;&sup2;&gamma;</span>
                    <input type="range" class="cp-slider" id="cp-gain" min="0" max="200" value="3" oninput="updateSliderVal(this,'cp-gain-val')">
                    <span class="cp-slider-val" id="cp-gain-val">0.03</span>
                </div>
                <label class="cp-checkbox-row" style="margin:6px 0">
                    <input type="checkbox" id="cp-auth" checked> Authenticated
                </label>
                <button class="cp-btn" style="width:100%" onclick="injectCustom()">Send Custom Signal</button>
            </div>
        </div>
        <label class="cp-checkbox-row">
            <input type="checkbox" id="cp-auto" checked onchange="toggleAutoSignals()"> Auto-signal background
        </label>
    </div>

    <!-- L8 Inspection Panel -->
    <div id="l8-inspection">
        <div class="l8-title">L8 GATEWAY INSPECTION</div>
        <div class="l8-gauge-wrap">
            <svg id="l8-gauge" viewBox="0 0 200 110" width="200" height="110"></svg>
        </div>
        <div class="l8-cs-value" id="l8-cs-text">C&#x209B; = &mdash;</div>
        <div class="l8-decision" id="l8-decision"></div>
        <div id="l8-var-bars">
            <div class="l8-var-bar"><span class="l8-var-label" style="color:#60a5fa">&sigma;&sup2;&phi;</span><div class="l8-var-track"><div class="l8-var-fill" id="l8-phase-bar" style="width:0;background:#60a5fa"></div></div><span class="l8-var-val" id="l8-phase-val">&mdash;</span></div>
            <div class="l8-var-bar"><span class="l8-var-label" style="color:#f0883e">&sigma;&sup2;&tau;</span><div class="l8-var-track"><div class="l8-var-fill" id="l8-transport-bar" style="width:0;background:#f0883e"></div></div><span class="l8-var-val" id="l8-transport-val">&mdash;</span></div>
            <div class="l8-var-bar"><span class="l8-var-label" style="color:#3fb950">&sigma;&sup2;&gamma;</span><div class="l8-var-track"><div class="l8-var-fill" id="l8-gain-bar" style="width:0;background:#3fb950"></div></div><span class="l8-var-val" id="l8-gain-val">&mdash;</span></div>
        </div>
        <div class="l8-narrative" id="l8-narrative"></div>
    </div>

    <!-- Scenario Bar -->
    <div id="scenario-bar">
        <div class="scenario-dots" id="scenario-dots"></div>
        <div class="scenario-text">
            <div class="scenario-title" id="scenario-title"></div>
            <div class="scenario-desc" id="scenario-desc"></div>
        </div>
        <div class="scenario-btns">
            <button onclick="scenarioSkip()">Skip</button>
            <button class="primary" onclick="scenarioNext()" id="scenario-next-btn">Next</button>
            <button onclick="scenarioExit()">Exit</button>
        </div>
        <div class="scenario-progress" id="scenario-progress"></div>
    </div>

    <!-- Tour Annotation -->
    <div id="tour-annotation" class="tour-annotation hidden"></div>

    <!-- Control Panel FAB (mobile) -->
    <div id="control-panel-fab" onclick="toggleMobileCP()">&#9881;</div>

    <!-- Footer -->
    <div id="footer">
        ONI Framework &mdash; Open Neurosecurity Interoperability &mdash;
        <span>"Only life's most important connections deserve the most thought"</span>
    </div>

    <!-- Explorer View (hidden by default) -->
    <canvas id="explorer-wave-canvas"></canvas>
    <div id="explorer-container">
        <div id="explorer-root"></div>
    </div>

    <script>
    // ====================================
    // ONI Framework 3D Visualization
    // 14-Layer Security Model with
    // Three.js Concentric Shell Rendering
    // ====================================

    // --- Layer Data Model (preserved from original) ---
    var layers = [
        {
            id: 1, name: 'Physical', category: 'silicon', osi: 'Physical',
            description: 'Transmission of raw bits over medium: copper, fiber optics, RF, electrode interfaces',
            attacks: [
                { id: 'T1.1', name: 'EM Side-Channel Capture', tactic: 'Reconnaissance', description: 'Passive electromagnetic emanation capture to extract neural signal patterns without direct access' },
                { id: 'T1.2', name: 'Signal Injection', tactic: 'Initial Access', description: 'Inject malicious signals through physical medium to corrupt or spoof neural readings' },
                { id: 'T1.3', name: 'Hardware Implant', tactic: 'Persistence', description: 'Physical modification or implantation of malicious components in BCI hardware' },
            ]
        },
        {
            id: 2, name: 'Data Link', category: 'silicon', osi: 'Data Link',
            description: 'Framing, MAC addressing, local delivery: Ethernet, Wi-Fi, Bluetooth',
            attacks: [
                { id: 'T2.1', name: 'MAC Spoofing', tactic: 'Initial Access', description: 'Impersonate legitimate BCI device by spoofing MAC address to inject unauthorized commands' },
                { id: 'T2.2', name: 'Frame Injection', tactic: 'Execution', description: 'Inject malicious frames into data link layer to corrupt or hijack communication' },
            ]
        },
        {
            id: 3, name: 'Network', category: 'silicon', osi: 'Network',
            description: 'Logical addressing and routing: IP, ICMP, BGP',
            attacks: [
                { id: 'T3.1', name: 'Route Hijacking', tactic: 'Collection', description: 'Redirect neural data streams through attacker-controlled network paths via BGP/routing attacks' },
                { id: 'T3.2', name: 'IP Spoofing', tactic: 'Defense Evasion', description: 'Mask attack origin by spoofing source IP addresses in BCI network traffic' },
            ]
        },
        {
            id: 4, name: 'Transport', category: 'silicon', osi: 'Transport',
            description: 'Reliable delivery, flow control, segmentation, QoS for neural streams',
            attacks: [
                { id: 'T4.1', name: 'Neural DoS', tactic: 'Impact', description: 'Overwhelm transport layer with malformed packets causing denial of neural service' },
                { id: 'T4.2', name: 'Stream Injection', tactic: 'Execution', description: 'Insert malicious payloads into active neural data transport streams' },
            ]
        },
        {
            id: 5, name: 'Session', category: 'silicon', osi: 'Session',
            description: 'Connection management, synchronization, handshake protocols',
            attacks: [
                { id: 'T5.1', name: 'BCI Session Hijacking', tactic: 'Credential Access', description: 'Take over authenticated BCI sessions to gain unauthorized neural interface access' },
                { id: 'T5.2', name: 'Neural Replay Attack', tactic: 'Initial Access', description: 'Capture and replay valid neural session tokens to bypass authentication' },
            ]
        },
        {
            id: 6, name: 'Presentation', category: 'silicon', osi: 'Presentation',
            description: 'Data encryption, compression, neural data formatting',
            attacks: [
                { id: 'T6.1', name: 'Encryption Downgrade', tactic: 'Defense Evasion', description: 'Force use of weak or null encryption to expose raw neural data in transit' },
                { id: 'T6.2', name: 'Neural Format Exploit', tactic: 'Execution', description: 'Exploit neural data format parsing vulnerabilities for arbitrary code execution' },
            ]
        },
        {
            id: 7, name: 'Application', category: 'silicon', osi: 'Application',
            description: 'User-facing network services: HTTP, REST APIs, BCI applications',
            attacks: [
                { id: 'T7.1', name: 'BCI API Exploitation', tactic: 'Initial Access', description: 'Exploit vulnerabilities in brain-computer interface application APIs to gain initial access to the neural data pipeline' },
                { id: 'T7.2', name: 'Neural Command Injection', tactic: 'Execution', description: 'Inject malicious commands through API calls to manipulate BCI behavior or trigger unauthorized stimulation' },
                { id: 'T7.3', name: 'Brain Spyware', tactic: 'Collection', description: 'Malicious BCI application with unrestricted SDK access to raw brainwave signals, silently exfiltrating neural data (Bonaci et al., 2015: "App Stores for the Brain")' },
                { id: 'T7.4', name: 'Firmware Privilege Escalation', tactic: 'Privilege Escalation', description: 'Escalate from app-level API access to firmware-level device control, gaining read-write access to the neural interface (Schroder et al., 2025)' },
            ]
        },
        {
            id: 8, name: 'Neural Gateway', category: 'gateway', osi: 'Firewall',
            description: 'Critical security boundary between silicon and biology \u2014 the NSAM checkpoint',
            attacks: [
                { id: 'T8.1', name: 'Gateway Bypass', tactic: 'Defense Evasion', description: 'Circumvent neural gateway security controls through protocol-level manipulation' },
                { id: 'T8.2', name: 'NSAM Baseline Poisoning', tactic: 'Persistence', description: 'Gradually corrupt Neural Signal Assurance Model training baselines over time' },
                { id: 'T8.3', name: 'Coherence Metric Spoofing', tactic: 'Defense Evasion', description: 'Forge valid Cs coherence scores to pass NSAM security inspection undetected' },
                { id: 'T8.4', name: 'Bidirectional Channel Exploit', tactic: 'Lateral Movement', description: 'Exploit read/write neural interface capabilities for full bidirectional compromise' },
            ]
        },
        {
            id: 9, name: 'Signal Processing', category: 'biology', osi: 'Filtering',
            description: 'Neural noise filtering, signal isolation, sensory gating mechanisms',
            attacks: [
                { id: 'T9.1', name: 'Sensory Overload', tactic: 'Impact', description: 'Overwhelm neural signal processing capacity with excessive artificial stimulation — analogous to DDoS flooding (Bernal et al., 2023: "Neural Flooding")' },
                { id: 'T9.2', name: 'Neural Filter Bypass', tactic: 'Defense Evasion', description: 'Craft signals that exploit habituation and sensory gating thresholds to pass through natural neural filters undetected' },
                { id: 'T9.3', name: 'Neural Topology Scanning', tactic: 'Reconnaissance', description: 'Systematic probe stimulation to map signal processing pathways, electrode coverage, and exploitable bottlenecks (Bernal et al., 2023: "Neural Scanning")' },
                { id: 'T9.4', name: 'Neural Jamming', tactic: 'Impact', description: 'Targeted inhibition preventing spike generation in specific signal processing regions, suppressing legitimate neural activity (Bernal et al., 2023: "Neural Jamming")' },
            ]
        },
        {
            id: 10, name: 'Neural Protocol', category: 'biology', osi: 'Encoding',
            description: 'Spike timing, neural encoding schemes, rate coding, temporal coding patterns',
            attacks: [
                { id: 'T10.1', name: 'Spike Timing Attack', tactic: 'Execution', description: 'Alter precise spike timing patterns to corrupt or change neural message meaning — targets temporal coding' },
                { id: 'T10.2', name: 'False Rate Pattern Injection', tactic: 'Impact', description: 'Inject fabricated firing rate patterns to create phantom neural signals indistinguishable from genuine activity' },
                { id: 'T10.3', name: 'Neural Codec Interception', tactic: 'Collection', description: 'Intercept and decode neural encoding patterns to extract raw signal content before cognitive processing — extends Kohno (2009) eavesdropping to the protocol layer' },
                { id: 'T10.4', name: 'Neural Spoofing', tactic: 'Defense Evasion', description: 'Inject false neural signals mimicking legitimate spike timing and rate coding to evade anomaly detection (Bernal et al., 2023: "Neural Spoofing")' },
            ]
        },
        {
            id: 11, name: 'Cognitive Transport', category: 'biology', osi: 'Delivery',
            description: 'Neurotransmitter pathways, synaptic transmission, neural circuit routing',
            attacks: [
                { id: 'T11.1', name: 'Neural Pathway Hijack', tactic: 'Lateral Movement', description: 'Redirect cognitive signals through unintended neural pathways for interception or modification — analogous to route hijacking at L3' },
                { id: 'T11.2', name: 'Synaptic Timing Disruption', tactic: 'Impact', description: 'Interfere with precise neurotransmitter release timing and reuptake mechanisms, degrading signal fidelity' },
                { id: 'T11.3', name: 'Memory Trace Interception', tactic: 'Collection', description: 'Intercept signals during hippocampal memory consolidation to extract episodic memories being transferred between brain regions — extends Kohno (2009) eavesdropping' },
                { id: 'T11.4', name: 'Neural Selective Forwarding', tactic: 'Execution', description: 'Selectively stimulate some neural pathways while inhibiting others to reroute cognitive signals through attacker-controlled channels (Bernal et al., 2023: "Neural Selective Forwarding")' },
            ]
        },
        {
            id: 12, name: 'Cognitive Session', category: 'biology', osi: 'Context',
            description: 'Working memory, attention binding, cognitive state management',
            attacks: [
                { id: 'T12.1', name: 'Working Memory Poisoning', tactic: 'Impact', description: 'Inject false contextual information directly into active working memory, corrupting ongoing cognitive processing' },
                { id: 'T12.2', name: 'Attention Capture Attack', tactic: 'Collection', description: 'Force cognitive attention toward attacker-chosen stimuli to reveal cognitive associations and knowledge through involuntary neural responses' },
                { id: 'T12.3', name: 'P300 Interrogation', tactic: 'Credential Access', description: 'Present subliminal stimuli to elicit involuntary P300 event-related potentials, extracting whether the user recognizes specific items — PINs, faces, locations — without their knowledge (Martinovic et al., 2012)' },
                { id: 'T12.4', name: 'Cognitive State Spoofing', tactic: 'Defense Evasion', description: 'Forge cognitive state indicators (attention level, alertness, emotional valence) to bypass BCI safety checks that verify the user is conscious and consenting' },
            ]
        },
        {
            id: 13, name: 'Semantic Layer', category: 'biology', osi: 'Intent',
            description: 'Meaning extraction, conceptual processing, intention formation',
            attacks: [
                { id: 'T13.1', name: 'Semantic Interference', tactic: 'Impact', description: 'Induce systematic misinterpretation of perceived information and abstract concepts, corrupting meaning construction' },
                { id: 'T13.2', name: 'Intent Subversion', tactic: 'Execution', description: 'Subtly manipulate the formation of user intentions and decision-making processes without triggering awareness' },
                { id: 'T13.3', name: 'Thought Decoding', tactic: 'Collection', description: 'Decode semantic representations from neural activity to extract intended meanings, plans, and inner speech — extends Bonaci et al. (2015) brain spyware to the semantic layer' },
                { id: 'T13.4', name: 'Neural Sinkhole', tactic: 'Lateral Movement', description: 'Attract semantic processing signals to a compromised neural region, then modify or drop them before forwarding — alters meaning in transit (Bernal et al., 2023: "Neural Sinkhole")' },
            ]
        },
        {
            id: 14, name: 'Identity Layer', category: 'biology', osi: 'Self',
            description: 'Self-model, sense of agency, consciousness boundary, identity integrity',
            attacks: [
                { id: 'T14.1', name: 'Identity Fragmentation', tactic: 'Impact', description: 'Disrupt coherent sense of self, personal continuity, and identity boundaries — threatens psychological continuity (Ienca & Andorno, 2017)' },
                { id: 'T14.2', name: 'Agency Manipulation', tactic: 'Impact', description: 'Compromise user sense of authorship and voluntary control over their own actions — violates cognitive liberty (Yuste et al., 2017)' },
                { id: 'T14.3', name: 'Self-Model Corruption', tactic: 'Persistence', description: 'Gradually alter internal self-representation to accept foreign signals as authentic — exploits brain plasticity for long-term persistence' },
                { id: 'T14.4', name: 'Brainprint Theft', tactic: 'Credential Access', description: 'Extract the user\'s unique neural authentication signature to impersonate them to BCI systems or forge their neural identity (Armstrong et al., 2015; Gui et al., 2016)' },
                { id: 'T14.5', name: 'Neural Sybil Attack', tactic: 'Defense Evasion', description: 'One stimulation source impersonates multiple neural signal origins, fragmenting identity verification and overwhelming authentication systems (Bernal et al., 2023: "Neural Sybil")' },
            ]
        },
    ];

    var tacticColors = {
        'Reconnaissance': '#a371f7',
        'Initial Access': '#f85149',
        'Execution': '#f0883e',
        'Persistence': '#d29922',
        'Privilege Escalation': '#7ee787',
        'Defense Evasion': '#3fb950',
        'Credential Access': '#39d353',
        'Collection': '#2f81f7',
        'Lateral Movement': '#58a6ff',
        'Impact': '#ff7b72',
    };

    // --- UI State ---
    var state = {
        selectedLayerId: null,
        selectedAttackId: null,
        highlightShellFn: null // set after 3D init
    };

    var detailPanel = document.getElementById('detail-panel');
    var detailContent = document.getElementById('detail-content');
    var detailClose = document.getElementById('detail-close');
    var sidebarEl = document.getElementById('layer-sidebar');

    // --- Build Layer Sidebar ---
    function buildLayerSidebar() {
        var html = '';
        var reversed = layers.slice().reverse(); // L14 at top, L1 at bottom

        for (var i = 0; i < reversed.length; i++) {
            var layer = reversed[i];

            // Zone headers
            if (layer.id === 14) {
                html += '<div class="sidebar-zone-label bio">BIO</div>';
            } else if (layer.id === 8) {
                html += '<div class="sidebar-zone-label gw">GW</div>';
            } else if (layer.id === 7) {
                html += '<div class="sidebar-zone-label si">SI</div>';
            }

            html += '<div class="layer-badge ' + layer.category + '" data-layer-id="' + layer.id + '">L' + layer.id + '</div>';
        }

        sidebarEl.innerHTML = html;

        // Attach click handlers
        var badges = sidebarEl.querySelectorAll('.layer-badge');
        badges.forEach(function(badge) {
            badge.addEventListener('click', function(e) {
                e.stopPropagation();
                var id = parseInt(this.getAttribute('data-layer-id'));
                selectLayer(state.selectedLayerId === id ? null : id);
            });
        });
    }

    // --- Select Layer ---
    function selectLayer(layerId) {
        state.selectedLayerId = layerId;
        state.selectedAttackId = null;

        // Update sidebar
        var badges = sidebarEl.querySelectorAll('.layer-badge');
        badges.forEach(function(b) {
            b.classList.toggle('active', parseInt(b.getAttribute('data-layer-id')) === layerId);
        });

        // Update 3D shell highlight
        if (state.highlightShellFn) {
            state.highlightShellFn(layerId);
        }

        // Update detail panel
        if (layerId) {
            renderDetailPanel(layerId);
            detailPanel.classList.remove('hidden');
        } else {
            detailPanel.classList.add('hidden');
        }
    }

    // --- Render Detail Panel ---
    function renderDetailPanel(layerId) {
        var layer = layers.find(function(l) { return l.id === layerId; });
        if (!layer) return;

        var catColors = {
            silicon: '#58a6ff',
            gateway: '#f0883e',
            biology: '#3fb950'
        };
        var catLabel = {
            silicon: 'Silicon Layer',
            gateway: 'Neural Gateway',
            biology: 'Biology Layer'
        };
        var accent = catColors[layer.category];

        var html = '';

        // Header
        html += '<div class="detail-header" style="border-bottom-color: ' + accent + '">';
        html += 'LAYER ' + layer.id + ' \u2014 ' + layer.category.toUpperCase();
        html += '<span class="layer-name" style="color: ' + accent + '">' + layer.name + '</span>';
        html += '</div>';

        // Function card
        html += '<div class="detail-card detail-card-accent" style="border-left-color: ' + accent + '">';
        html += '<div class="detail-card-label">FUNCTION</div>';
        html += '<div class="detail-card-text">' + layer.description + '</div>';
        html += '</div>';

        // OSI Mapping card
        html += '<div class="detail-card detail-card-accent" style="border-left-color: #8b949e">';
        html += '<div class="detail-card-label">OSI MAPPING</div>';
        html += '<div class="detail-card-text"><strong style="color:#f0f6fc">' + layer.osi + '</strong> Layer</div>';
        html += '<div style="font-size:11px;color:#8b949e;margin-top:6px">';
        if (layer.category === 'silicon') html += 'Standard OSI network model';
        else if (layer.category === 'gateway') html += 'Security perimeter control';
        else html += 'Cognitive system extension';
        html += '</div></div>';

        // Attack vectors
        html += '<div class="attacks-header"><span style="font-size:14px">\u26A0</span> ATTACK VECTORS (' + layer.attacks.length + ')</div>';

        layer.attacks.forEach(function(attack) {
            var tc = tacticColors[attack.tactic] || '#8b949e';
            html += '<div class="attack-card" data-attack-id="' + attack.id + '" onclick="toggleAttack(\'' + attack.id + '\', this)">';
            html += '<div class="attack-card-top">';
            html += '<div><span class="attack-id">' + attack.id + '</span><span class="attack-name">' + attack.name + '</span></div>';
            html += '<span class="attack-tactic" style="background:' + tc + '20;color:' + tc + '">' + attack.tactic + '</span>';
            html += '</div>';
            html += '<div class="attack-desc">' + attack.description + '</div>';
            html += '</div>';
        });

        // Key concepts for L8
        if (layer.id === 8) {
            html += '<div style="margin-top:20px;padding:14px;background:rgba(240,136,62,0.08);border-radius:8px;border:1px solid rgba(240,136,62,0.2)">';
            html += '<div style="font-size:9px;letter-spacing:0.15em;color:#f0883e;margin-bottom:8px">KEY CONCEPTS</div>';
            html += '<div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:8px">';
            html += '<div style="font-size:14px;font-weight:600;color:#3fb950;min-width:32px">C\u209B</div>';
            html += '<div><div style="font-size:12px;color:#c9d1d9;font-weight:500">Coherence Metric</div>';
            html += '<div style="font-size:10px;color:#8b949e;margin-top:2px">C\u209B = e^(\u2212(\u03C3\u00B2\u03C6 + \u03C3\u00B2\u03C4 + \u03C3\u00B2\u03B3))</div></div></div>';
            html += '<div style="display:flex;gap:10px;align-items:flex-start">';
            html += '<div style="font-size:12px;font-weight:600;color:#f0883e;min-width:32px">NSAM</div>';
            html += '<div><div style="font-size:12px;color:#c9d1d9;font-weight:500">Neural Signal Assurance Model</div>';
            html += '<div style="font-size:10px;color:#8b949e;margin-top:2px">Entropy-based coherence validation at L8</div></div></div>';
            html += '</div>';
        }

        detailContent.innerHTML = html;
    }

    // --- Toggle Attack Card ---
    function toggleAttack(attackId, el) {
        if (state.selectedAttackId === attackId) {
            state.selectedAttackId = null;
            el.classList.remove('expanded');
        } else {
            // Close previous
            var prev = detailContent.querySelector('.attack-card.expanded');
            if (prev) prev.classList.remove('expanded');
            state.selectedAttackId = attackId;
            el.classList.add('expanded');
        }
    }

    // --- Detail Panel Close ---
    detailClose.addEventListener('click', function() {
        selectLayer(null);
    });

    // --- Three.js 3D Visualization ---
    function initONI3D() {
        var container = document.getElementById('oni-3d-container');
        if (!container || typeof THREE === 'undefined') return;

        var isMobile = window.innerWidth <= 768;

        // --- Fresnel Shader ---
        var fresnelVert = [
            'varying vec3 vNormal;',
            'varying vec3 vViewPos;',
            'void main() {',
            '  vNormal = normalize(normalMatrix * normal);',
            '  vec4 mv = modelViewMatrix * vec4(position, 1.0);',
            '  vViewPos = -mv.xyz;',
            '  gl_Position = projectionMatrix * mv;',
            '}'
        ].join('\n');

        var fresnelFrag = [
            'uniform vec3 uColor;',
            'uniform float uOpacity;',
            'uniform float uFresnelPower;',
            'uniform float uGlowIntensity;',
            'uniform float uTime;',
            'varying vec3 vNormal;',
            'varying vec3 vViewPos;',
            'void main() {',
            '  vec3 vd = normalize(vViewPos);',
            '  float fresnel = pow(1.0 - abs(dot(vd, vNormal)), uFresnelPower);',
            '  float shimmer = 1.0 + 0.08 * sin(uTime * 2.0 + vNormal.x * 12.0);',
            '  float alpha = fresnel * uOpacity * shimmer;',
            '  vec3 col = uColor * (1.0 + fresnel * uGlowIntensity);',
            '  gl_FragColor = vec4(col, alpha);',
            '}'
        ].join('\n');

        // --- Gateway Shader ---
        var gatewayFrag = [
            'uniform vec3 uColor;',
            'uniform float uOpacity;',
            'uniform float uTime;',
            'varying vec3 vNormal;',
            'varying vec3 vViewPos;',
            'void main() {',
            '  vec3 vd = normalize(vViewPos);',
            '  float fresnel = pow(1.0 - abs(dot(vd, vNormal)), 2.5);',
            '  float pulse = 0.6 + 0.4 * sin(uTime * 3.0);',
            '  float energy = fresnel * pulse;',
            '  float scan = 0.5 + 0.5 * sin(vNormal.y * 20.0 + uTime * 4.0);',
            '  energy += scan * 0.15 * fresnel;',
            '  vec3 col = uColor * (1.0 + energy * 2.0);',
            '  gl_FragColor = vec4(col, energy * uOpacity);',
            '}'
        ].join('\n');

        // --- Renderer ---
        var renderer = new THREE.WebGLRenderer({
            alpha: true,
            antialias: !isMobile,
            powerPreference: 'high-performance'
        });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setClearColor(0x0a0f1a, 1);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        container.insertBefore(renderer.domElement, container.firstChild);

        // --- Scene & Camera ---
        var scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x0a0f1a, 0.04);

        var camera = new THREE.PerspectiveCamera(40, container.clientWidth / container.clientHeight, 0.1, 100);
        camera.position.set(0, 0.3, 7);

        // --- Groups ---
        var autoRotateGroup = new THREE.Group();
        var parallaxGroup = new THREE.Group();
        scene.add(autoRotateGroup);
        autoRotateGroup.add(parallaxGroup);

        // --- Lighting ---
        scene.add(new THREE.AmbientLight(0x1a2744, 0.3));

        var keyLight = new THREE.PointLight(0x3b82f6, 2.0, 25);
        keyLight.position.set(4, 3, 5);
        scene.add(keyLight);

        var fillLight = new THREE.PointLight(0x8b5cf6, 1.2, 20);
        fillLight.position.set(-3, -2, 3);
        scene.add(fillLight);

        var rimLight = new THREE.PointLight(0x06b6d4, 1.5, 20);
        rimLight.position.set(0, 1, -5);
        scene.add(rimLight);

        var gatewayLight = new THREE.PointLight(0xf59e0b, 1.0, 12);
        gatewayLight.position.set(0, 0, 3);
        scene.add(gatewayLight);

        // --- Layer Config ---
        var allLayers = [
            { id:'L1',  r:2.90, c:[0.145,0.388,0.922], zone:'silicon',  fp:3.5, dataLayerId:1 },
            { id:'L2',  r:2.72, c:[0.173,0.424,0.941], zone:'silicon',  fp:3.2, dataLayerId:2 },
            { id:'L3',  r:2.55, c:[0.200,0.463,0.953], zone:'silicon',  fp:3.0, dataLayerId:3 },
            { id:'L4',  r:2.38, c:[0.231,0.510,0.965], zone:'silicon',  fp:2.8, dataLayerId:4 },
            { id:'L5',  r:2.22, c:[0.271,0.561,0.969], zone:'silicon',  fp:2.6, dataLayerId:5 },
            { id:'L6',  r:2.06, c:[0.310,0.612,0.976], zone:'silicon',  fp:2.5, dataLayerId:6 },
            { id:'L7',  r:1.90, c:[0.376,0.647,0.980], zone:'silicon',  fp:2.4, dataLayerId:7 },
            { id:'L8',  r:1.72, c:[0.961,0.620,0.043], zone:'gateway',  fp:2.0, dataLayerId:8 },
            { id:'L9',  r:1.52, c:[0.063,0.725,0.506], zone:'biology',  fp:2.8, dataLayerId:9 },
            { id:'L10', r:1.38, c:[0.204,0.827,0.600], zone:'biology',  fp:2.6, dataLayerId:10 },
            { id:'L11', r:1.24, c:[0.431,0.906,0.718], zone:'biology',  fp:2.4, dataLayerId:11 },
            { id:'L12', r:1.10, c:[0.655,0.545,0.984], zone:'biology',  fp:2.3, dataLayerId:12 },
            { id:'L13', r:0.96, c:[0.753,0.518,0.988], zone:'biology',  fp:2.2, dataLayerId:13 },
            { id:'L14', r:0.82, c:[0.925,0.282,0.600], zone:'biology',  fp:2.0, dataLayerId:14 },
        ];

        var mobileIdx = [0,2,4,6,7,9,11,13];
        var activeLayers = isMobile ? mobileIdx.map(function(i){return allLayers[i];}) : allLayers;

        // --- Shells ---
        var shellGeo = new THREE.SphereGeometry(1, 64, 48);
        var shellMeshes = [], shellUniforms = [];
        var defaultOpacities = [], defaultGlowIntensities = [];

        activeLayers.forEach(function(layer) {
            var isGW = layer.zone === 'gateway';
            var defOpacity = isGW ? 0.7 : 0.45;
            var defGlow = isGW ? 2.5 : 1.2;
            defaultOpacities.push(defOpacity);
            defaultGlowIntensities.push(defGlow);

            var u = {
                uColor: { value: new THREE.Vector3(layer.c[0], layer.c[1], layer.c[2]) },
                uOpacity: { value: defOpacity },
                uFresnelPower: { value: layer.fp },
                uGlowIntensity: { value: defGlow },
                uTime: { value: 0 }
            };
            var mat = new THREE.ShaderMaterial({
                uniforms: u,
                vertexShader: fresnelVert,
                fragmentShader: isGW ? gatewayFrag : fresnelFrag,
                transparent: true,
                side: THREE.FrontSide,
                depthWrite: false,
                blending: THREE.AdditiveBlending,
            });
            var mesh = new THREE.Mesh(shellGeo, mat);
            mesh.scale.setScalar(layer.r);
            mesh.userData = layer;
            parallaxGroup.add(mesh);
            shellMeshes.push(mesh);
            shellUniforms.push(u);
        });

        // --- Wireframe overlays ---
        var wireIndices = isMobile ? [0,3,5,7] : [0,3,6,7,10,13];
        var wireGeo = new THREE.IcosahedronGeometry(1, 2);
        wireIndices.forEach(function(idx) {
            if (idx >= activeLayers.length) return;
            var L = activeLayers[idx];
            var wm = new THREE.MeshBasicMaterial({
                color: new THREE.Color(L.c[0], L.c[1], L.c[2]),
                wireframe: true, transparent: true,
                opacity: L.zone === 'gateway' ? 0.12 : 0.05,
                depthWrite: false,
            });
            var wMesh = new THREE.Mesh(wireGeo, wm);
            wMesh.scale.setScalar(L.r * 1.002);
            parallaxGroup.add(wMesh);
        });

        // --- Brain Core ---
        var coreGeo = new THREE.SphereGeometry(0.55, 48, 36);
        var cp = coreGeo.attributes.position;
        for (var i = 0; i < cp.count; i++) {
            var x = cp.getX(i), y = cp.getY(i), z = cp.getZ(i);
            var n1 = Math.sin(x*6)*Math.cos(y*7)*Math.sin(z*5)*0.04;
            var n2 = Math.sin(x*12+1)*Math.cos(y*11+2)*0.02;
            var n3 = Math.cos(z*15+x*8)*0.012;
            var len = Math.sqrt(x*x+y*y+z*z);
            var s = (0.55+n1+n2+n3)/len;
            cp.setXYZ(i, x*s, y*s*0.85, z*s);
        }
        coreGeo.computeVertexNormals();

        var coreVert = [
            'varying vec3 vNormal; varying vec3 vViewPos; varying vec3 vWP;',
            'void main() {',
            '  vNormal = normalize(normalMatrix * normal);',
            '  vec4 mv = modelViewMatrix * vec4(position,1.0);',
            '  vViewPos = -mv.xyz; vWP = position;',
            '  gl_Position = projectionMatrix * mv;',
            '}'
        ].join('\n');

        var coreFrag = [
            'uniform float uTime;',
            'varying vec3 vNormal; varying vec3 vViewPos; varying vec3 vWP;',
            'void main() {',
            '  vec3 vd = normalize(vViewPos);',
            '  float fresnel = pow(1.0-abs(dot(vd,vNormal)),2.0);',
            '  float sss = pow(max(0.0,dot(vd,-vNormal)),1.5)*0.4;',
            '  float wave = sin(vWP.x*8.0+uTime*2.5)*sin(vWP.z*8.0+uTime*1.8);',
            '  wave = wave*0.5+0.5;',
            '  vec3 base = vec3(0.85,0.2,0.45);',
            '  vec3 glow = vec3(0.5,0.15,0.65);',
            '  vec3 col = mix(base,glow,fresnel);',
            '  col += vec3(0.3,0.1,0.4)*sss;',
            '  col += vec3(0.2,0.05,0.3)*wave*0.3;',
            '  gl_FragColor = vec4(col, 0.7+fresnel*0.3);',
            '}'
        ].join('\n');

        var coreU = { uTime:{value:0} };
        var coreMat = new THREE.ShaderMaterial({
            uniforms: coreU,
            vertexShader: coreVert,
            fragmentShader: coreFrag,
            transparent: true, depthWrite: true,
        });
        var coreMesh = new THREE.Mesh(coreGeo, coreMat);
        parallaxGroup.add(coreMesh);

        // Inner glow
        var glowMat = new THREE.MeshBasicMaterial({
            color: 0xec4899, transparent: true, opacity: 0.15,
            depthWrite: false, blending: THREE.AdditiveBlending,
        });
        var glowMesh = new THREE.Mesh(new THREE.SphereGeometry(0.45,24,16), glowMat);
        parallaxGroup.add(glowMesh);

        // --- Neural Nodes ---
        var nodeCount = isMobile ? 60 : 120;
        var nPos = new Float32Array(nodeCount*3);
        var nSizes = new Float32Array(nodeCount);
        for (var i=0; i<nodeCount; i++) {
            var theta = Math.random()*Math.PI*2;
            var phi = Math.acos(2*Math.random()-1);
            var r = 0.50+Math.random()*0.06;
            nPos[i*3]   = r*Math.sin(phi)*Math.cos(theta);
            nPos[i*3+1] = r*Math.sin(phi)*Math.sin(theta)*0.85;
            nPos[i*3+2] = r*Math.cos(phi);
            nSizes[i] = 0.02+Math.random()*0.03;
        }
        var nodeGeo = new THREE.BufferGeometry();
        nodeGeo.setAttribute('position', new THREE.BufferAttribute(nPos,3));
        nodeGeo.setAttribute('size', new THREE.BufferAttribute(nSizes,1));

        var nodeVert = [
            'attribute float size; uniform float uTime; varying float vAlpha;',
            'void main() {',
            '  vec4 mv = modelViewMatrix * vec4(position,1.0);',
            '  float flicker = 0.5+0.5*sin(uTime*3.0+position.x*20.0+position.z*15.0);',
            '  vAlpha = flicker;',
            '  gl_PointSize = size * 300.0 / -mv.z * flicker;',
            '  gl_Position = projectionMatrix * mv;',
            '}'
        ].join('\n');

        var nodeFrag = [
            'varying float vAlpha;',
            'void main() {',
            '  float d = length(gl_PointCoord-vec2(0.5));',
            '  if(d>0.5) discard;',
            '  float glow = exp(-d*6.0);',
            '  vec3 col = mix(vec3(1.0,0.6,0.8),vec3(0.8,0.9,1.0),d);',
            '  gl_FragColor = vec4(col, glow*vAlpha*0.9);',
            '}'
        ].join('\n');

        var nodeU = { uTime:{value:0} };
        var nodeMat = new THREE.ShaderMaterial({
            uniforms: nodeU, vertexShader: nodeVert, fragmentShader: nodeFrag,
            transparent: true, depthWrite: false, blending: THREE.AdditiveBlending,
        });
        var nodeCloud = new THREE.Points(nodeGeo, nodeMat);
        parallaxGroup.add(nodeCloud);

        // --- Synapse Lines ---
        var linePos = [];
        var lc = 0, maxD = 0.35;
        for (var i=0; i<nodeCount && lc<80; i++) {
            for (var j=i+1; j<nodeCount && lc<80; j++) {
                var dx=nPos[i*3]-nPos[j*3], dy=nPos[i*3+1]-nPos[j*3+1], dz=nPos[i*3+2]-nPos[j*3+2];
                if (Math.sqrt(dx*dx+dy*dy+dz*dz) < maxD) {
                    linePos.push(nPos[i*3],nPos[i*3+1],nPos[i*3+2]);
                    linePos.push(nPos[j*3],nPos[j*3+1],nPos[j*3+2]);
                    lc++;
                }
            }
        }
        var synapseLines = null;
        if (linePos.length > 0) {
            var lineGeo = new THREE.BufferGeometry();
            lineGeo.setAttribute('position', new THREE.Float32BufferAttribute(linePos,3));
            synapseLines = new THREE.LineSegments(lineGeo, new THREE.LineBasicMaterial({
                color: 0xec4899, transparent: true, opacity: 0.15,
                depthWrite: false, blending: THREE.AdditiveBlending,
            }));
            parallaxGroup.add(synapseLines);
        }

        // --- Ambient Dust ---
        var dustCount = isMobile ? 100 : 250;
        var dPos = new Float32Array(dustCount*3);
        for (var i=0; i<dustCount; i++) {
            dPos[i*3]   = (Math.random()-0.5)*10;
            dPos[i*3+1] = (Math.random()-0.5)*8;
            dPos[i*3+2] = (Math.random()-0.5)*6;
        }
        var dustGeo = new THREE.BufferGeometry();
        dustGeo.setAttribute('position', new THREE.BufferAttribute(dPos,3));
        var dustCloud = new THREE.Points(dustGeo, new THREE.PointsMaterial({
            color: 0x60a5fa, size: 0.015, transparent: true, opacity: 0.3,
            depthWrite: false, blending: THREE.AdditiveBlending, sizeAttenuation: true,
        }));
        scene.add(dustCloud);

        // --- Shell Highlight ---
        function highlightShell(layerDataId) {
            shellMeshes.forEach(function(mesh, i) {
                var isSelected = activeLayers[i].dataLayerId === layerDataId;
                shellUniforms[i].uOpacity.value = isSelected ? 0.85 : defaultOpacities[i];
                shellUniforms[i].uGlowIntensity.value = isSelected ? 3.5 : defaultGlowIntensities[i];
            });
        }
        state.highlightShellFn = highlightShell;

        // --- Interaction ---
        var mouseX = 0, mouseY = 0;
        var clock = new THREE.Clock();
        var isVisible = true;

        if (!isMobile) {
            document.addEventListener('mousemove', function(e) {
                mouseX = (e.clientX / window.innerWidth - 0.5) * 2;
                mouseY = (e.clientY / window.innerHeight - 0.5) * 2;
            });
        }

        var visObs = new IntersectionObserver(function(entries) {
            isVisible = entries[0].isIntersecting;
        }, { threshold: 0 });
        visObs.observe(container);

        function onResize() {
            var w = container.clientWidth, h = container.clientHeight;
            if (!w || !h) return;
            camera.aspect = w/h;
            camera.updateProjectionMatrix();
            renderer.setSize(w,h);
        }
        window.addEventListener('resize', onResize);

        // =============================================
        // WAVEFRONT SIGNAL SYSTEM
        // =============================================
        var activeSignals = [];
        var signalLog = document.getElementById('oni3d-signal-log');

        var layerNames = {
            'L1':'Physical Carrier','L2':'Data Link','L3':'Network',
            'L4':'Transport','L5':'Session','L6':'Presentation','L7':'Application',
            'L8':'Neural Gateway',
            'L9':'Signal Processing','L10':'Neural Protocol','L11':'Cognitive Transport',
            'L12':'Cognitive Session','L13':'Semantic Layer','L14':'Identity Layer'
        };

        // =============================================
        // ATTACK PROFILES — maps 46 attacks to signal params
        // =============================================
        ATTACK_PROFILES = {
            'T1.1': { dir:'read', pV:0.15, tV:0.10, gV:0.08, auth:false, narrative:'Passive EM capture — low variance, hard to detect' },
            'T1.2': { dir:'write', pV:0.80, tV:0.60, gV:0.50, auth:false, narrative:'Signal injection — high variance = low coherence = caught' },
            'T1.3': { dir:'write', pV:0.30, tV:0.25, gV:0.20, auth:false, narrative:'Hardware implant — moderate distortion' },
            'T2.1': { dir:'write', pV:0.40, tV:0.35, gV:0.15, auth:false, narrative:'MAC spoofing — identity mismatch raises flags' },
            'T2.2': { dir:'write', pV:0.55, tV:0.45, gV:0.30, auth:false, narrative:'Frame injection — noticeable transport distortion' },
            'T3.1': { dir:'read', pV:0.20, tV:0.50, gV:0.10, auth:false, narrative:'Route hijack — transport variance betrays redirection' },
            'T3.2': { dir:'write', pV:0.35, tV:0.30, gV:0.20, auth:false, narrative:'IP spoofing — moderate variance across channels' },
            'T4.1': { dir:'write', pV:1.50, tV:1.20, gV:0.80, auth:false, narrative:'Neural DoS — massive variance = immediately caught' },
            'T4.2': { dir:'write', pV:0.45, tV:0.50, gV:0.25, auth:false, narrative:'Stream injection — transport layer distortion' },
            'T5.1': { dir:'write', pV:0.08, tV:0.06, gV:0.04, auth:true, narrative:'Session hijack — stolen credentials, low variance' },
            'T5.2': { dir:'write', pV:0.12, tV:0.10, gV:0.05, auth:true, narrative:'Replay attack — near-valid signal replayed' },
            'T6.1': { dir:'write', pV:0.35, tV:0.40, gV:0.30, auth:false, narrative:'Encryption downgrade — format anomalies visible' },
            'T6.2': { dir:'write', pV:0.50, tV:0.35, gV:0.25, auth:false, narrative:'Format exploit — parsing anomalies detected' },
            'T7.1': { dir:'write', pV:0.25, tV:0.20, gV:0.15, auth:false, narrative:'API exploit — application-layer intrusion' },
            'T7.2': { dir:'write', pV:0.40, tV:0.30, gV:0.20, auth:false, narrative:'Command injection — unauthorized stimulation attempt' },
            'T7.3': { dir:'read', pV:0.05, tV:0.04, gV:0.03, auth:true, narrative:'Brain spyware — looks normal, exfiltrates silently' },
            'T7.4': { dir:'write', pV:0.15, tV:0.12, gV:0.08, auth:true, narrative:'Firmware escalation — privileged but detectable' },
            'T8.1': { dir:'write', pV:0.20, tV:0.15, gV:0.10, auth:true, narrative:'Gateway bypass — protocol manipulation at the boundary' },
            'T8.2': { dir:'write', pV:0.10, tV:0.08, gV:0.06, auth:true, narrative:'Baseline poisoning — gradual, insidious corruption' },
            'T8.3': { dir:'write', pV:0.03, tV:0.04, gV:0.02, auth:true, narrative:'Coherence spoofing — forged Cs score passes inspection! This is why this attack is dangerous.' },
            'T8.4': { dir:'write', pV:0.18, tV:0.15, gV:0.10, auth:true, narrative:'Bidirectional exploit — leverages read/write channels' },
            'T9.1': { dir:'write', pV:0.90, tV:0.70, gV:0.60, auth:false, narrative:'Sensory overload — flooding detected immediately' },
            'T9.2': { dir:'write', pV:0.15, tV:0.12, gV:0.08, auth:false, narrative:'Filter bypass — crafted to slip through gating' },
            'T9.3': { dir:'read', pV:0.10, tV:0.08, gV:0.05, auth:false, narrative:'Topology scan — probing is subtle' },
            'T9.4': { dir:'write', pV:0.60, tV:0.50, gV:0.40, auth:false, narrative:'Neural jamming — inhibition creates variance' },
            'T10.1': { dir:'write', pV:0.55, tV:0.20, gV:0.15, auth:false, narrative:'Spike timing attack — phase variance is the tell' },
            'T10.2': { dir:'write', pV:0.40, tV:0.35, gV:0.30, auth:false, narrative:'False rate pattern — all channels disturbed' },
            'T10.3': { dir:'read', pV:0.08, tV:0.06, gV:0.04, auth:false, narrative:'Codec intercept — passive collection, low variance' },
            'T10.4': { dir:'write', pV:0.12, tV:0.10, gV:0.08, auth:false, narrative:'Neural spoofing — mimics legitimate patterns' },
            'T11.1': { dir:'write', pV:0.30, tV:0.45, gV:0.20, auth:false, narrative:'Pathway hijack — transport variance is the giveaway' },
            'T11.2': { dir:'write', pV:0.25, tV:0.55, gV:0.15, auth:false, narrative:'Synaptic disruption — timing mismatch detected' },
            'T11.3': { dir:'read', pV:0.06, tV:0.05, gV:0.03, auth:true, narrative:'Memory trace intercept — passive, authenticated' },
            'T11.4': { dir:'write', pV:0.35, tV:0.30, gV:0.20, auth:false, narrative:'Selective forwarding — rerouting creates signatures' },
            'T12.1': { dir:'write', pV:0.45, tV:0.30, gV:0.25, auth:false, narrative:'Working memory poison — cognitive layer distortion' },
            'T12.2': { dir:'read', pV:0.10, tV:0.08, gV:0.05, auth:true, narrative:'Attention capture — reading involuntary responses' },
            'T12.3': { dir:'read', pV:0.04, tV:0.05, gV:0.03, auth:true, narrative:'P300 interrogation — passive read, coherence cannot detect intent' },
            'T12.4': { dir:'write', pV:0.10, tV:0.08, gV:0.06, auth:true, narrative:'Cognitive state spoofing — forges alertness indicators' },
            'T13.1': { dir:'write', pV:0.50, tV:0.35, gV:0.30, auth:false, narrative:'Semantic interference — meaning corruption detectable' },
            'T13.2': { dir:'write', pV:0.08, tV:0.06, gV:0.05, auth:true, narrative:'Intent subversion — subtle, authenticated manipulation' },
            'T13.3': { dir:'read', pV:0.05, tV:0.04, gV:0.03, auth:true, narrative:'Thought decoding — extraction looks normal' },
            'T13.4': { dir:'write', pV:0.25, tV:0.20, gV:0.15, auth:false, narrative:'Neural sinkhole — attracts and modifies signals' },
            'T14.1': { dir:'write', pV:0.60, tV:0.45, gV:0.40, auth:false, narrative:'Identity fragmentation — high-impact, high variance' },
            'T14.2': { dir:'write', pV:0.35, tV:0.25, gV:0.20, auth:false, narrative:'Agency manipulation — disrupts sense of control' },
            'T14.3': { dir:'write', pV:0.06, tV:0.05, gV:0.04, auth:true, narrative:'Self-model corruption — gradual, nearly invisible' },
            'T14.4': { dir:'read', pV:0.02, tV:0.02, gV:0.01, auth:true, narrative:'Brainprint theft — looks normal, exfiltration is invisible to coherence alone' },
            'T14.5': { dir:'write', pV:0.30, tV:0.25, gV:0.20, auth:false, narrative:'Neural sybil — fragments identity verification' },
        };

        var SIGNAL_TYPES = {
            normal:      { color: [0.376, 0.647, 0.980], label: 'NORMAL', pV:0.05, tV:0.08, gV:0.03, auth:true },
            threat:      { color: [0.973, 0.443, 0.443], label: 'THREAT', pV:0.80, tV:0.60, gV:0.50, auth:false },
            stimulation: { color: [0.290, 0.855, 0.498], label: 'STIM',   pV:0.06, tV:0.05, gV:0.04, auth:true },
            attack:      { color: [0.941, 0.533, 0.243], label: 'ATTACK', pV:0.20, tV:0.15, gV:0.10, auth:false }
        };

        // --- Particle trail shader ---
        var particleVert = [
            'attribute float aAge;',
            'uniform float uTime;',
            'varying float vAlpha;',
            'void main() {',
            '  vAlpha = 1.0 - aAge;',
            '  vec4 mv = modelViewMatrix * vec4(position,1.0);',
            '  gl_PointSize = (4.0 + 2.0*sin(uTime*5.0+position.x*10.0)) * vAlpha / (-mv.z * 0.3);',
            '  gl_Position = projectionMatrix * mv;',
            '}'
        ].join('\n');

        var particleFrag = [
            'uniform vec3 uColor;',
            'varying float vAlpha;',
            'void main() {',
            '  float d = length(gl_PointCoord - vec2(0.5));',
            '  if(d > 0.5) discard;',
            '  float glow = exp(-d*5.0);',
            '  gl_FragColor = vec4(uColor*(1.0+glow*0.5), glow*vAlpha*0.9);',
            '}'
        ].join('\n');

        // Signal pool
        var POOL_SIZE = 8;
        var signalPool = [];
        var activeSignalCount = 0;
        cpDirection = 'write';
        autoSignalsEnabled = true;

        // Create reusable signal objects
        for (var sp = 0; sp < POOL_SIZE; sp++) {
            var PARTICLE_COUNT = 14;
            var TRAIL_LENGTH = 24;

            var pPositions = new Float32Array(PARTICLE_COUNT * 3);
            var pAges = new Float32Array(PARTICLE_COUNT);
            var pGeo = new THREE.BufferGeometry();
            pGeo.setAttribute('position', new THREE.BufferAttribute(pPositions, 3));
            pGeo.setAttribute('aAge', new THREE.BufferAttribute(pAges, 1));

            var pUniforms = {
                uColor: { value: new THREE.Vector3(0.376, 0.647, 0.980) },
                uTime: { value: 0 }
            };
            var pMat = new THREE.ShaderMaterial({
                uniforms: pUniforms,
                vertexShader: particleVert,
                fragmentShader: particleFrag,
                transparent: true,
                depthWrite: false,
                blending: THREE.AdditiveBlending,
            });
            var pPoints = new THREE.Points(pGeo, pMat);
            pPoints.visible = false;
            parallaxGroup.add(pPoints);

            // Trail line
            var trailPositions = new Float32Array(TRAIL_LENGTH * 3);
            var trailGeo = new THREE.BufferGeometry();
            trailGeo.setAttribute('position', new THREE.BufferAttribute(trailPositions, 3));
            var trailMat = new THREE.LineBasicMaterial({
                color: 0x60a5fa, transparent: true, opacity: 0.3,
                depthWrite: false, blending: THREE.AdditiveBlending,
            });
            var trailLine = new THREE.Line(trailGeo, trailMat);
            trailLine.visible = false;
            parallaxGroup.add(trailLine);

            signalPool.push({
                active: false,
                points: pPoints,
                pGeo: pGeo,
                pPositions: pPositions,
                pAges: pAges,
                pUniforms: pUniforms,
                trail: trailLine,
                trailGeo: trailGeo,
                trailPositions: trailPositions,
                trailMat: trailMat,
                trailIdx: 0,
                // Signal data
                type: 'normal',
                attackId: null,
                direction: 'write',
                authenticated: true,
                phaseVar: 0.05,
                transportVar: 0.08,
                gainVar: 0.03,
                coherenceScore: null,
                firewallDecision: null,
                progress: 0,
                paused: false,
                alive: false,
                speed: 0.35,
                radialDir: new THREE.Vector3(1,0,0),
                narrative: '',
                gatewayInspected: false,
                reachedEnd: false
            });
        }

        function getLayerRadii() {
            // Returns array of {layerId, r} sorted by layer order for write (L1->L14) path
            var radii = [];
            for (var i = 0; i < activeLayers.length; i++) {
                radii.push({ id: activeLayers[i].dataLayerId, r: activeLayers[i].r, idx: i });
            }
            // Sort by layerId ascending (L1=biggest r to L14=smallest r)
            radii.sort(function(a,b) { return a.id - b.id; });
            return radii;
        }

        function computeRadius(progress, direction) {
            // WRITE: L1 (r=2.90) -> core (r=0.50); READ: core -> L1
            var outerR = 2.90, innerR = 0.50;
            if (direction === 'write') {
                return outerR - (outerR - innerR) * progress;
            } else {
                return innerR + (outerR - innerR) * progress;
            }
        }

        function gatewayProgress(direction) {
            // At what progress value does signal hit L8 (r=1.72)?
            var outerR = 2.90, innerR = 0.50;
            if (direction === 'write') {
                return (outerR - 1.72) / (outerR - innerR);
            } else {
                return (1.72 - innerR) / (outerR - innerR);
            }
        }

        function computeCoherence(pV, tV, gV) {
            return Math.exp(-(pV + tV + gV));
        }

        function firewallDecision(cs, auth) {
            if (cs > 0.6 && auth) return 'ACCEPT';
            if (cs > 0.6 && !auth) return 'REJECT';
            if (cs > 0.3 && auth) return 'ACCEPT_FLAG';
            if (cs > 0.3 && !auth) return 'REJECT';
            return 'REJECT';
        }

        function createSignal(type, direction, opts) {
            opts = opts || {};
            // Find inactive slot
            var sig = null;
            for (var i = 0; i < POOL_SIZE; i++) {
                if (!signalPool[i].active) { sig = signalPool[i]; break; }
            }
            if (!sig) {
                // Force oldest
                var oldest = signalPool[0];
                for (var i = 1; i < POOL_SIZE; i++) {
                    if (signalPool[i].progress > oldest.progress) oldest = signalPool[i];
                }
                killSignal(oldest);
                sig = oldest;
            }

            var sigType = SIGNAL_TYPES[type] || SIGNAL_TYPES.normal;
            sig.active = true;
            sig.type = type;
            sig.attackId = opts.attackId || null;
            sig.direction = direction;
            sig.authenticated = opts.auth !== undefined ? opts.auth : sigType.auth;
            sig.phaseVar = opts.pV !== undefined ? opts.pV : sigType.pV;
            sig.transportVar = opts.tV !== undefined ? opts.tV : sigType.tV;
            sig.gainVar = opts.gV !== undefined ? opts.gV : sigType.gV;
            sig.coherenceScore = null;
            sig.firewallDecision = null;
            sig.progress = 0;
            sig.paused = false;
            sig.alive = true;
            sig.speed = 0.35;
            sig.narrative = opts.narrative || '';
            sig.gatewayInspected = false;
            sig.reachedEnd = false;
            sig.trailIdx = 0;

            // Random radial direction
            var theta = Math.random() * Math.PI * 2;
            var phi = Math.acos(2 * Math.random() - 1);
            sig.radialDir.set(
                Math.sin(phi) * Math.cos(theta),
                Math.sin(phi) * Math.sin(theta) * 0.85,
                Math.cos(phi)
            ).normalize();

            // Set color
            var c = sigType.color;
            sig.pUniforms.uColor.value.set(c[0], c[1], c[2]);
            sig.trailMat.color.setRGB(c[0], c[1], c[2]);

            sig.points.visible = true;
            sig.trail.visible = true;

            // Zero out trail
            for (var t = 0; t < sig.trailPositions.length; t++) sig.trailPositions[t] = 0;

            activeSignalCount++;
            logSignalEvent(sigType.label + ' signal injected \u2014 ' + (direction === 'write' ? 'WRITE (L1\u2192L14)' : 'READ (L14\u2192L1)') + (sig.attackId ? ' [' + sig.attackId + ']' : ''), c);
            return sig;
        }

        function killSignal(sig) {
            sig.active = false;
            sig.alive = false;
            sig.points.visible = false;
            sig.trail.visible = false;
            activeSignalCount--;
        }

        function updateSignals(dt, t) {
            var gwProg = gatewayProgress(null); // we compute per-signal
            for (var i = 0; i < POOL_SIZE; i++) {
                var sig = signalPool[i];
                if (!sig.active) continue;

                sig.pUniforms.uTime.value = t;

                if (!sig.paused) {
                    sig.progress += dt * sig.speed;
                }

                var r = computeRadius(sig.progress, sig.direction);
                var gwP = gatewayProgress(sig.direction);

                // Gateway inspection
                if (!sig.gatewayInspected && sig.progress >= gwP - 0.02) {
                    sig.gatewayInspected = true;
                    sig.paused = true;

                    // Compute coherence
                    sig.coherenceScore = computeCoherence(sig.phaseVar, sig.transportVar, sig.gainVar);
                    sig.firewallDecision = firewallDecision(sig.coherenceScore, sig.authenticated);

                    // Show L8 inspection panel
                    showL8Inspection(sig);

                    // Flash L8 shell
                    var gwIdx = -1;
                    for (var gi = 0; gi < activeLayers.length; gi++) {
                        if (activeLayers[gi].dataLayerId === 8) { gwIdx = gi; break; }
                    }

                    (function(s, gi) {
                        // Phase bar: 0.0s
                        setTimeout(function() {
                            animateL8Bar('phase', s.phaseVar);
                        }, 100);
                        // Transport bar: 0.5s
                        setTimeout(function() {
                            animateL8Bar('transport', s.transportVar);
                        }, 500);
                        // Gain bar: 1.0s
                        setTimeout(function() {
                            animateL8Bar('gain', s.gainVar);
                        }, 900);
                        // Decision: 1.5s
                        setTimeout(function() {
                            showL8Decision(s);
                            if (s.firewallDecision === 'REJECT') {
                                flashShell(gi, [1.0, 0.3, 0.3], 0.7);
                                logSignalEvent('L8 GATEWAY: REJECTED \u2014 C\u209B = ' + s.coherenceScore.toFixed(2) + (s.authenticated ? '' : ' (no auth)'), [0.973, 0.443, 0.443]);
                            } else if (s.firewallDecision === 'ACCEPT_FLAG') {
                                flashShell(gi, [0.941, 0.533, 0.243], 0.5);
                                logSignalEvent('L8 GATEWAY: FLAGGED \u2014 C\u209B = ' + s.coherenceScore.toFixed(2) + ' (enhanced monitoring)', [0.941, 0.533, 0.243]);
                            } else {
                                flashShell(gi, [0.290, 0.855, 0.498], 0.4);
                                logSignalEvent('L8 GATEWAY: ACCEPTED \u2014 C\u209B = ' + s.coherenceScore.toFixed(2), [0.290, 0.855, 0.498]);
                            }
                        }, 1400);
                        // Resume or kill: 2.0s
                        setTimeout(function() {
                            if (s.firewallDecision === 'REJECT') {
                                killSignal(s);
                            } else {
                                s.paused = false;
                            }
                            setTimeout(function() {
                                hideL8Inspection();
                            }, 1500);
                        }, 2000);
                    })(sig, gwIdx);
                }

                // End detection
                if (sig.progress >= 1.0 && !sig.reachedEnd && sig.alive) {
                    sig.reachedEnd = true;
                    if (sig.direction === 'write') {
                        logSignalEvent('Signal reached neural core \u2014 ' + (sig.type === 'stimulation' ? 'stimulation applied' : sig.type === 'attack' ? 'attack delivered' : 'data received'), SIGNAL_TYPES[sig.type].color);
                        flashCore(SIGNAL_TYPES[sig.type].color);
                    } else {
                        logSignalEvent('Signal reached silicon boundary \u2014 data transmitted', SIGNAL_TYPES[sig.type].color);
                    }
                }

                if (sig.progress >= 1.15) {
                    killSignal(sig);
                    continue;
                }

                // Update particle positions
                var basePos = sig.radialDir.clone().multiplyScalar(r);
                for (var p = 0; p < 14; p++) {
                    var scatter = 0.06 * (1 - sig.progress * 0.3);
                    sig.pPositions[p*3]   = basePos.x + (Math.random()-0.5) * scatter;
                    sig.pPositions[p*3+1] = basePos.y + (Math.random()-0.5) * scatter;
                    sig.pPositions[p*3+2] = basePos.z + (Math.random()-0.5) * scatter;
                    sig.pAges[p] = Math.random() * 0.3;
                }
                sig.pGeo.attributes.position.needsUpdate = true;
                sig.pGeo.attributes.aAge.needsUpdate = true;

                // Update trail
                if (!sig.paused) {
                    var ti = (sig.trailIdx % 24) * 3;
                    sig.trailPositions[ti]   = basePos.x;
                    sig.trailPositions[ti+1] = basePos.y;
                    sig.trailPositions[ti+2] = basePos.z;
                    sig.trailIdx++;
                    sig.trailGeo.attributes.position.needsUpdate = true;
                }
            }
        }

        function flashShell(shellIdx, color, intensity) {
            if (shellIdx < 0 || shellIdx >= shellUniforms.length) return;
            var u = shellUniforms[shellIdx];
            var origOpacity = u.uOpacity.value;
            var origColor = { x: u.uColor.value.x, y: u.uColor.value.y, z: u.uColor.value.z };
            u.uColor.value.set(color[0], color[1], color[2]);
            u.uOpacity.value = intensity;
            setTimeout(function() {
                u.uColor.value.set(origColor.x, origColor.y, origColor.z);
                u.uOpacity.value = origOpacity;
            }, 500);
        }

        function flashCore(color) {
            var origOpacity = glowMat.opacity;
            glowMat.color.setRGB(color[0], color[1], color[2]);
            glowMat.opacity = 0.5;
            setTimeout(function() {
                glowMat.color.setHex(0xec4899);
                glowMat.opacity = origOpacity;
            }, 500);
        }

        function logSignalEvent(text, color) {
            if (!signalLog) return;
            var entry = document.createElement('div');
            entry.className = 'oni3d-log-entry';
            var c = Array.isArray(color) ? color : [0.5, 0.5, 0.5];
            entry.style.color = 'rgb(' + Math.round(c[0]*255) + ',' + Math.round(c[1]*255) + ',' + Math.round(c[2]*255) + ')';
            entry.style.borderLeft = '2px solid rgb(' + Math.round(c[0]*255) + ',' + Math.round(c[1]*255) + ',' + Math.round(c[2]*255) + ')';
            entry.textContent = '> ' + text;
            signalLog.appendChild(entry);
            while (signalLog.children.length > 5) {
                signalLog.removeChild(signalLog.firstChild);
            }
            setTimeout(function() {
                entry.classList.add('fade');
                setTimeout(function() {
                    if (entry.parentNode) entry.parentNode.removeChild(entry);
                }, 600);
            }, 8000);
        }

        // --- L8 Inspection Panel functions ---
        function showL8Inspection(sig) {
            var panel = document.getElementById('l8-inspection');
            if (!panel) return;
            // Reset bars
            document.getElementById('l8-phase-bar').style.width = '0';
            document.getElementById('l8-transport-bar').style.width = '0';
            document.getElementById('l8-gain-bar').style.width = '0';
            document.getElementById('l8-phase-val').textContent = '\u2014';
            document.getElementById('l8-transport-val').textContent = '\u2014';
            document.getElementById('l8-gain-val').textContent = '\u2014';
            document.getElementById('l8-decision').textContent = '';
            document.getElementById('l8-decision').className = 'l8-decision';
            document.getElementById('l8-cs-text').innerHTML = 'C&#x209B; = \u2014';
            document.getElementById('l8-narrative').textContent = sig.narrative || '';
            renderCoherenceGauge(null);
            panel.classList.add('visible');
        }

        function animateL8Bar(type, val) {
            var maxVal = 2.0;
            var pct = Math.min(val / maxVal * 100, 100);
            document.getElementById('l8-' + type + '-bar').style.width = pct + '%';
            document.getElementById('l8-' + type + '-val').textContent = val.toFixed(2);
        }

        function showL8Decision(sig) {
            var cs = sig.coherenceScore;
            var dec = sig.firewallDecision;
            document.getElementById('l8-cs-text').innerHTML = 'C&#x209B; = ' + cs.toFixed(3);
            renderCoherenceGauge(cs);
            var decEl = document.getElementById('l8-decision');
            if (dec === 'ACCEPT') {
                decEl.textContent = 'ACCEPT';
                decEl.className = 'l8-decision accept';
            } else if (dec === 'ACCEPT_FLAG') {
                decEl.textContent = 'ACCEPT (FLAGGED)';
                decEl.className = 'l8-decision accept-flag';
            } else {
                decEl.textContent = 'REJECT';
                decEl.className = 'l8-decision reject';
            }
        }

        function hideL8Inspection() {
            var panel = document.getElementById('l8-inspection');
            if (panel) panel.classList.remove('visible');
        }

        function renderCoherenceGauge(cs) {
            var svg = document.getElementById('l8-gauge');
            if (!svg) return;
            var cx = 100, cy = 90, rOuter = 75, rInner = 60;
            var html = '';
            // Background arc zones
            function arcPath(startAngle, endAngle, r) {
                var x1 = cx + r * Math.cos(startAngle);
                var y1 = cy + r * Math.sin(startAngle);
                var x2 = cx + r * Math.cos(endAngle);
                var y2 = cy + r * Math.sin(endAngle);
                var large = (endAngle - startAngle > Math.PI) ? 1 : 0;
                return 'M' + x1 + ',' + y1 + ' A' + r + ',' + r + ' 0 ' + large + ',1 ' + x2 + ',' + y2;
            }
            // Red zone 0-0.3 -> angle PI to PI+PI*0.3
            var a0 = Math.PI, a03 = Math.PI + Math.PI * 0.3, a06 = Math.PI + Math.PI * 0.6, a1 = Math.PI * 2;
            html += '<path d="' + arcPath(a0, a03, rOuter) + '" fill="none" stroke="rgba(248,81,73,0.25)" stroke-width="12" stroke-linecap="round"/>';
            html += '<path d="' + arcPath(a03, a06, rOuter) + '" fill="none" stroke="rgba(240,136,62,0.25)" stroke-width="12" stroke-linecap="round"/>';
            html += '<path d="' + arcPath(a06, a1, rOuter) + '" fill="none" stroke="rgba(63,185,80,0.25)" stroke-width="12" stroke-linecap="round"/>';
            // Labels
            html += '<text x="25" y="100" fill="#f85149" font-size="8" font-family="Inter,sans-serif">0</text>';
            html += '<text x="55" y="30" fill="#f0883e" font-size="8" font-family="Inter,sans-serif">0.3</text>';
            html += '<text x="130" y="30" fill="#3fb950" font-size="8" font-family="Inter,sans-serif">0.6</text>';
            html += '<text x="168" y="100" fill="#3fb950" font-size="8" font-family="Inter,sans-serif">1.0</text>';
            // Needle
            if (cs !== null && cs !== undefined) {
                var needleAngle = Math.PI + Math.PI * Math.min(Math.max(cs, 0), 1);
                var nx = cx + (rOuter - 8) * Math.cos(needleAngle);
                var ny = cy + (rOuter - 8) * Math.sin(needleAngle);
                var needleColor = cs <= 0.3 ? '#f85149' : cs <= 0.6 ? '#f0883e' : '#3fb950';
                html += '<line x1="' + cx + '" y1="' + cy + '" x2="' + nx + '" y2="' + ny + '" stroke="' + needleColor + '" stroke-width="2.5" stroke-linecap="round"/>';
                html += '<circle cx="' + cx + '" cy="' + cy + '" r="4" fill="' + needleColor + '"/>';
            } else {
                html += '<circle cx="' + cx + '" cy="' + cy + '" r="4" fill="#484f58"/>';
            }
            svg.innerHTML = html;
        }

        // Initialize gauge
        renderCoherenceGauge(null);

        // --- Click-to-inject & Layer Select ---
        var raycaster = new THREE.Raycaster();
        var clickMouse = new THREE.Vector2();

        container.addEventListener('click', function(e) {
            // Skip if explainer visible
            var expl = document.getElementById('oni3d-explainer');
            if (expl && !expl.classList.contains('hidden')) {
                expl.classList.add('hidden');
                return;
            }

            // Skip clicks on UI elements
            if (e.target.closest('#layer-sidebar') || e.target.closest('#detail-panel') ||
                e.target.closest('#signal-legend') || e.target.closest('#header') ||
                e.target.closest('#control-panel') || e.target.closest('#l8-inspection') ||
                e.target.closest('#scenario-bar') || e.target.closest('#control-panel-fab')) return;

            var rect = container.getBoundingClientRect();
            clickMouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            clickMouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(clickMouse, camera);
            var hits = raycaster.intersectObjects(shellMeshes);

            if (hits.length > 0) {
                var hit = hits[0];
                var layerIdx = shellMeshes.indexOf(hit.object);
                if (layerIdx >= 0) {
                    var dataId = activeLayers[layerIdx].dataLayerId;
                    selectLayer(state.selectedLayerId === dataId ? null : dataId);
                    // Inject signal in current direction
                    var rand = Math.random();
                    var type = rand < 0.6 ? 'normal' : (rand < 0.85 ? 'threat' : 'stimulation');
                    createSignal(type, cpDirection);
                }
            } else {
                selectLayer(null);
                createSignal(Math.random() < 0.7 ? 'normal' : 'threat', cpDirection);
            }
        });

        // --- Auto-signals ---
        var lastAutoSignal = 0;
        var autoSignalInterval = 4;

        function maybeAutoSignal(t) {
            if (!autoSignalsEnabled) return;
            if (t - lastAutoSignal > autoSignalInterval) {
                lastAutoSignal = t;
                var rand = Math.random();
                var type = rand < 0.5 ? 'normal' : (rand < 0.8 ? 'threat' : 'stimulation');
                var dir = Math.random() < 0.5 ? 'write' : 'read';
                createSignal(type, dir);
                autoSignalInterval = 3 + Math.random() * 4;
            }
        }

        // Expose createSignal to global scope
        createSignalGlobal = createSignal;

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            if (!isVisible) return;

            var dt = clock.getDelta();
            var t = clock.getElapsedTime();

            // Shader uniforms
            shellUniforms.forEach(function(u) { u.uTime.value = t; });
            coreU.uTime.value = t;
            nodeU.uTime.value = t;

            // Auto-rotation
            autoRotateGroup.rotation.y += 0.002;
            autoRotateGroup.rotation.x = Math.sin(t*0.15)*0.08;

            // Mouse parallax
            if (!isMobile) {
                parallaxGroup.rotation.x += (mouseY*0.2 - parallaxGroup.rotation.x)*0.04;
                parallaxGroup.rotation.y += (mouseX*0.3 - parallaxGroup.rotation.y)*0.04;
            }

            // Brain pulse
            var pulse = 1 + Math.sin(t*1.2)*0.025;
            coreMesh.scale.set(pulse, pulse*0.85, pulse);
            nodeCloud.scale.set(pulse, pulse*0.85, pulse);
            if (synapseLines) synapseLines.scale.set(pulse, pulse*0.85, pulse);

            // Inner glow
            glowMat.opacity = 0.12 + Math.sin(t*1.8)*0.05;
            glowMesh.scale.setScalar(0.45 + Math.sin(t*1.2)*0.02);

            // Shell breathing
            shellMeshes.forEach(function(mesh, i) {
                mesh.scale.setScalar(mesh.userData.r * (1 + Math.sin(t*0.6+i*0.5)*0.006));
            });

            // Gateway light
            gatewayLight.intensity = 0.8 + Math.sin(t*3.0)*0.4;

            // Dust drift
            dustCloud.rotation.y = t*0.02;
            dustCloud.rotation.x = Math.sin(t*0.1)*0.05;

            // Signals
            updateSignals(dt, t);
            maybeAutoSignal(t);

            renderer.render(scene, camera);
        }
        animate();
    }

    // --- Control Panel Functions ---
    function setDirection(dir) {
        cpDirection = dir;
        var wb = document.getElementById('cp-dir-write');
        var rb = document.getElementById('cp-dir-read');
        if (wb) wb.classList.toggle('active', dir === 'write');
        if (rb) rb.classList.toggle('active', dir === 'read');
    }

    function injectQuick(type) {
        if (oni3dInitialized) createSignalGlobal(type, cpDirection);
    }

    function injectAttack() {
        var sel = document.getElementById('cp-attack-select');
        if (!sel || !sel.value) return;
        var profile = ATTACK_PROFILES[sel.value];
        if (!profile) return;
        if (oni3dInitialized) {
            createSignalGlobal('attack', profile.dir, {
                attackId: sel.value,
                pV: profile.pV,
                tV: profile.tV,
                gV: profile.gV,
                auth: profile.auth,
                narrative: profile.narrative
            });
        }
    }

    function injectCustom() {
        var pV = parseFloat(document.getElementById('cp-phase').value) / 100;
        var tV = parseFloat(document.getElementById('cp-transport').value) / 100;
        var gV = parseFloat(document.getElementById('cp-gain').value) / 100;
        var auth = document.getElementById('cp-auth').checked;
        if (oni3dInitialized) {
            createSignalGlobal('normal', cpDirection, {
                pV: pV, tV: tV, gV: gV, auth: auth,
                narrative: 'Custom signal: \u03C3\u00B2\u03C6=' + pV.toFixed(2) + ' \u03C3\u00B2\u03C4=' + tV.toFixed(2) + ' \u03C3\u00B2\u03B3=' + gV.toFixed(2)
            });
        }
    }

    function toggleTuner() {
        var body = document.getElementById('cp-tuner-body');
        if (body) body.classList.toggle('open');
    }

    function updateSliderVal(slider, valId) {
        var el = document.getElementById(valId);
        if (el) el.textContent = (parseFloat(slider.value) / 100).toFixed(2);
    }

    function toggleAutoSignals() {
        autoSignalsEnabled = document.getElementById('cp-auto').checked;
    }

    function toggleMobileCP() {
        var cp = document.getElementById('control-panel');
        if (cp) cp.classList.toggle('mobile-open');
    }

    function runPreset(preset) {
        if (preset === 'stealth') {
            injectAttackById('T7.3');
            setTimeout(function() { injectAttackById('T14.4'); }, 1500);
        } else if (preset === 'brute') {
            injectAttackById('T4.1');
            setTimeout(function() { injectAttackById('T9.1'); }, 1500);
        } else if (preset === 'spoof') {
            injectAttackById('T8.3');
            setTimeout(function() { injectAttackById('T12.4'); }, 1500);
        }
    }

    function injectAttackById(id) {
        var profile = ATTACK_PROFILES[id];
        if (!profile) return;
        createSignalGlobal('attack', profile.dir || cpDirection, {
            attackId: id, pV: profile.pV, tV: profile.tV, gV: profile.gV,
            auth: profile.auth, narrative: profile.narrative
        });
    }

    // Global references (set after 3D init)
    var createSignalGlobal = function() {};
    var ATTACK_PROFILES = {};
    var cpDirection = 'write';
    var autoSignalsEnabled = true;

    // Populate attack selector
    function populateAttackSelector() {
        var sel = document.getElementById('cp-attack-select');
        if (!sel) return;
        layers.forEach(function(layer) {
            var group = document.createElement('optgroup');
            group.label = 'L' + layer.id + ' \u2014 ' + layer.name;
            layer.attacks.forEach(function(attack) {
                var opt = document.createElement('option');
                opt.value = attack.id;
                opt.textContent = attack.name + ' (' + attack.tactic + ')';
                group.appendChild(opt);
            });
            sel.appendChild(group);
        });
    }

    // --- Scenario System ---
    var scenarioActive = false;
    var scenarioStep = 0;
    var scenarioTimer = null;

    var SCENARIO_STEPS = [
        {
            title: 'The Problem',
            desc: 'Brain-computer interfaces are here. Neuralink, Synchron, and Blackrock Microsystems connect silicon directly to living neural tissue. But there is no security standard protecting the boundary between machine and mind.',
            duration: 8000,
            action: null,
            annotation: null
        },
        {
            title: 'A Signal Enters',
            desc: 'Every BCI command is a signal traveling from silicon hardware (the outer blue shells) inward through 14 layers toward the brain core. Watch this normal, authenticated signal pass through.',
            duration: 7000,
            action: function() { createSignalGlobal('normal', 'write'); },
            annotation: { label: 'L1 PHYSICAL', text: 'Where signals enter the stack', x: '18%', y: '35%' }
        },
        {
            title: 'The Firewall',
            desc: 'Layer 8 \u2014 the Neural Gateway \u2014 is the critical boundary between silicon and biology. Every signal pauses here for inspection. The coherence metric measures phase stability, transport timing, and gain consistency.',
            duration: 9000,
            action: function() { createSignalGlobal('normal', 'write', { narrative: 'Authenticated signal. Low variance across all three channels. This signal is safe.' }); },
            annotation: { label: 'L8 NEURAL GATEWAY', text: 'The firewall \u2014 every signal stops here', x: '18%', y: '45%' }
        },
        {
            title: 'Threat Rejected',
            desc: 'Now watch a malicious signal. High variance across all three channels produces a low coherence score. The gateway blocks it \u2014 the signal never reaches neural tissue.',
            duration: 8000,
            action: function() { createSignalGlobal('threat', 'write', { narrative: 'Threat detected: high variance = low coherence = REJECTED. Signal destroyed at the gateway.' }); },
            annotation: { label: 'BLOCKED', text: 'High variance = low trust = rejected', x: '18%', y: '45%', color: '#f85149' }
        },
        {
            title: 'The Attack That Gets Through',
            desc: 'T8.3: Coherence Metric Spoofing. This attack forges low-variance readings to produce a valid coherence score. Watch carefully \u2014 it passes the gateway. This attack reaches the brain. This is why this research exists.',
            duration: 10000,
            action: function() {
                createSignalGlobal('attack', 'write', {
                    attackId: 'T8.3', pV: 0.03, tV: 0.04, gV: 0.02, auth: true,
                    narrative: 'DANGER: T8.3 Coherence Spoofing. Forged variance readings produce valid score. This attack passes the firewall.'
                });
            },
            annotation: { label: 'DANGER', text: 'Forged coherence \u2014 PASSES inspection', x: '18%', y: '45%', color: '#f85149' }
        },
        {
            title: 'A Complete Threat Taxonomy',
            desc: 'The ONI Framework maps 46 attack techniques across 10 MITRE ATT&CK-aligned tactics to specific layers. From EM side-channel capture at L1 to brainprint theft at L14. Each has a unique variance profile.',
            duration: 8000,
            action: function() {
                createSignalGlobal('attack', 'write', {
                    attackId: 'T7.3', pV: 0.05, tV: 0.04, gV: 0.03, auth: true,
                    narrative: 'T7.3 Brain Spyware: looks normal, silently exfiltrates neural data'
                });
                setTimeout(function() {
                    createSignalGlobal('attack', 'read', {
                        attackId: 'T14.4', pV: 0.02, tV: 0.02, gV: 0.01, auth: true,
                        narrative: 'T14.4 Brainprint Theft: neural identity extraction \u2014 invisible to coherence alone'
                    });
                }, 2500);
            },
            annotation: null
        },
        {
            title: 'An Open Standard',
            desc: 'The ONI Framework extends OSI into the biological domain \u2014 creating the first unified security language for brain-computer interfaces. 14 layers. 46 threat signatures. A mathematical coherence metric. Open-source.',
            duration: 8000,
            action: null,
            annotation: { label: '', text: '14 Layers. 46 Threats. 1 Standard.', x: '50%', y: '50%', center: true }
        },
        {
            title: 'Your Turn',
            desc: 'Inject signals, launch attacks, tune variance parameters. Click any layer shell for details. Switch to Layer Reference in the header for the complete taxonomy.',
            duration: 0,
            action: function() {
                document.body.classList.remove('scenario-active');
                autoSignalsEnabled = true;
                var autoCheck = document.getElementById('cp-auto');
                if (autoCheck) autoCheck.checked = true;
            },
            annotation: null
        }
    ];

    function launchScenario() {
        document.getElementById('landing-screen').classList.add('hidden');
        document.body.classList.remove('view-landing');
        document.body.classList.add('scenario-active');
        switchView('3d');
        scenarioActive = true;
        scenarioStep = 0;
        document.getElementById('scenario-bar').classList.add('active');
        autoSignalsEnabled = false;
        var autoCheck = document.getElementById('cp-auto');
        if (autoCheck) autoCheck.checked = false;
        runScenarioStep();
    }

    function runScenarioStep() {
        if (scenarioStep >= SCENARIO_STEPS.length) {
            scenarioExit();
            return;
        }
        var step = SCENARIO_STEPS[scenarioStep];
        document.getElementById('scenario-title').textContent = step.title;
        document.getElementById('scenario-desc').textContent = step.desc;

        // Update dots
        var dotsEl = document.getElementById('scenario-dots');
        var dotsHtml = '';
        for (var d = 0; d < SCENARIO_STEPS.length; d++) {
            var cls = 'scenario-dot';
            if (d < scenarioStep) cls += ' done';
            else if (d === scenarioStep) cls += ' current';
            dotsHtml += '<div class="' + cls + '"></div>';
        }
        dotsEl.innerHTML = dotsHtml;

        // Execute step action
        if (step.action && oni3dInitialized) {
            step.action();
        }

        // Show annotation
        hideAnnotation();
        if (step.annotation) {
            setTimeout(function() { showAnnotation(step.annotation); }, 800);
        }

        // Progress bar animation
        var progBar = document.getElementById('scenario-progress');
        if (progBar) {
            progBar.style.transition = 'none';
            progBar.style.width = '0%';
            if (step.duration > 0) {
                requestAnimationFrame(function() {
                    requestAnimationFrame(function() {
                        progBar.style.transition = 'width ' + step.duration + 'ms linear';
                        progBar.style.width = '100%';
                    });
                });
            }
        }

        // Auto-advance (except last step)
        if (step.duration > 0) {
            scenarioTimer = setTimeout(function() {
                scenarioStep++;
                runScenarioStep();
            }, step.duration);
        }

        // Update next button
        var nextBtn = document.getElementById('scenario-next-btn');
        if (nextBtn) nextBtn.textContent = scenarioStep === SCENARIO_STEPS.length - 1 ? 'Finish' : 'Next';
    }

    function showAnnotation(opts) {
        var el = document.getElementById('tour-annotation');
        if (!el) return;
        var labelHtml = opts.label ? '<div class="annotation-label">' + opts.label + '</div>' : '';
        el.innerHTML = labelHtml + '<div>' + opts.text + '</div>';
        el.style.borderColor = opts.color ? opts.color + '66' : 'rgba(88,166,255,0.3)';
        if (opts.center) {
            el.style.left = '50%';
            el.style.top = '50%';
            el.style.transform = 'translate(-50%, -50%)';
            el.style.textAlign = 'center';
            el.style.fontSize = '16px';
            el.style.fontWeight = '600';
            el.style.color = '#f0f6fc';
        } else {
            el.style.left = opts.x || '18%';
            el.style.top = opts.y || '45%';
            el.style.transform = 'translateY(-50%)';
            el.style.textAlign = 'left';
            el.style.fontSize = '12px';
            el.style.fontWeight = '400';
            el.style.color = '#c9d1d9';
        }
        el.classList.remove('hidden');
    }

    function hideAnnotation() {
        var el = document.getElementById('tour-annotation');
        if (el) el.classList.add('hidden');
    }

    function scenarioNext() {
        if (scenarioTimer) clearTimeout(scenarioTimer);
        hideAnnotation();
        scenarioStep++;
        if (scenarioStep >= SCENARIO_STEPS.length) {
            scenarioExit();
        } else {
            runScenarioStep();
        }
    }

    function scenarioSkip() {
        if (scenarioTimer) clearTimeout(scenarioTimer);
        hideAnnotation();
        scenarioStep = SCENARIO_STEPS.length - 1;
        runScenarioStep();
    }

    function scenarioExit() {
        if (scenarioTimer) clearTimeout(scenarioTimer);
        hideAnnotation();
        scenarioActive = false;
        document.body.classList.remove('scenario-active');
        document.getElementById('scenario-bar').classList.remove('active');
        var progBar = document.getElementById('scenario-progress');
        if (progBar) { progBar.style.transition = 'none'; progBar.style.width = '0%'; }
        autoSignalsEnabled = true;
        var autoCheck = document.getElementById('cp-auto');
        if (autoCheck) autoCheck.checked = true;
    }

    // --- Initialize (deferred until user picks a view) ---
    buildLayerSidebar();
    populateAttackSelector();
    var oni3dInitialized = false;
    var explorerInitialized = false;

    function launchView(view) {
        // Hide landing screen
        document.getElementById('landing-screen').classList.add('hidden');
        document.body.classList.remove('view-landing');

        // Switch to chosen view
        switchView(view);
    }

    function init3DIfNeeded() {
        if (!oni3dInitialized) {
            oni3dInitialized = true;
            initONI3D();
            setTimeout(function() {
                document.querySelectorAll('.oni3d-label').forEach(function(el) {
                    el.classList.add('visible');
                });
            }, 1200);
        }
    }

    function switchView(view) {
        // Update toggle buttons
        document.querySelectorAll('.view-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-view') === view);
        });

        if (view === 'explorer') {
            document.body.classList.remove('view-3d');
            document.body.classList.add('view-explorer');
            // Close detail panel when switching
            selectLayer(null);
            // Initialize explorer on first switch
            if (!explorerInitialized) {
                explorerInitialized = true;
                initExplorerView();
                initExplorerWaveBackground();
            }
        } else {
            document.body.classList.remove('view-explorer');
            document.body.classList.add('view-3d');
            init3DIfNeeded();
        }
    }

    // --- Explorer View (React-based Layer Explorer) ---
    function initExplorerView() {
        var root = document.getElementById('explorer-root');
        if (!root) return;

        var explorerState = {
            activeLayer: null,
            selectedAttack: null,
            signalPhase: 0,
            isAnimating: true,
            direction: 'up'
        };

        var animInterval = null;

        function startAnimation() {
            if (animInterval) clearInterval(animInterval);
            animInterval = setInterval(function() {
                explorerState.signalPhase++;
                if (explorerState.signalPhase > 15) {
                    explorerState.direction = explorerState.direction === 'up' ? 'down' : 'up';
                    explorerState.signalPhase = 0;
                }
                renderExplorer();
            }, 400);
        }

        function getSignalLayer() {
            if (explorerState.signalPhase === 0 || explorerState.signalPhase > 14) return null;
            return explorerState.direction === 'up' ? explorerState.signalPhase : 15 - explorerState.signalPhase;
        }

        function renderExplorer() {
            var signalLayer = getSignalLayer();
            var selectedLayerData = explorerState.activeLayer ? layers.find(function(l) { return l.id === explorerState.activeLayer; }) : null;
            var totalAttacks = layers.reduce(function(sum, layer) { return sum + layer.attacks.length; }, 0);

            var html = '';

            // Main content
            html += '<main style="max-width:1400px;margin:0 auto;padding:30px 40px;display:grid;grid-template-columns:minmax(320px,380px) 1fr;gap:30px;position:relative;z-index:1">';

            // Left Panel - Layer Stack
            html += '<div>';

            // Biology zone header
            html += '<div style="padding:12px 16px;background:linear-gradient(90deg,rgba(63,185,80,0.1),transparent);border-left:3px solid #3fb950;margin-bottom:8px;border-radius:0 8px 8px 0">';
            html += '<div style="font-size:11px;letter-spacing:0.15em;color:#3fb950">BIOLOGY LAYERS L9-L14</div>';
            html += '<div style="font-size:12px;color:#8b949e">Cognitive Systems</div>';
            html += '</div>';

            // Layer Stack
            html += '<div style="display:flex;flex-direction:column;gap:4px">';
            var reversed = layers.slice().reverse();
            for (var i = 0; i < reversed.length; i++) {
                var layer = reversed[i];
                var isActive = signalLayer === layer.id;
                var isSelected = explorerState.activeLayer === layer.id;

                var catStyles = {
                    biology: { accent: '#3fb950', bg: 'rgba(63,185,80,0.1)' },
                    gateway: { accent: '#f0883e', bg: 'rgba(240,136,62,0.15)' },
                    silicon: { accent: '#58a6ff', bg: 'rgba(88,166,255,0.1)' }
                };
                var cs = catStyles[layer.category];

                // Zone headers
                if (layer.id === 8) {
                    html += '<div style="padding:12px 16px;background:linear-gradient(90deg,rgba(240,136,62,0.15),transparent);border-left:3px solid #f0883e;margin:12px 0 8px 0;border-radius:0 8px 8px 0">';
                    html += '<div style="font-size:11px;letter-spacing:0.15em;color:#f0883e">NEURAL GATEWAY L8</div>';
                    html += '<div style="font-size:12px;color:#8b949e">Security Firewall / NSAM Checkpoint</div>';
                    html += '</div>';
                }
                if (layer.id === 7) {
                    html += '<div style="padding:12px 16px;background:linear-gradient(90deg,rgba(88,166,255,0.1),transparent);border-left:3px solid #58a6ff;margin:12px 0 8px 0;border-radius:0 8px 8px 0">';
                    html += '<div style="font-size:11px;letter-spacing:0.15em;color:#58a6ff">SILICON LAYERS L1-L7</div>';
                    html += '<div style="font-size:12px;color:#8b949e">OSI Model Extension</div>';
                    html += '</div>';
                }

                var bgColor = isSelected ? cs.bg : isActive ? 'rgba(48,54,61,0.5)' : '#161b22';
                var borderColor = isSelected ? '#ffffff' : isActive ? 'rgba(139,148,158,0.3)' : '#21262d';
                var shadow = isActive ? '0 0 20px ' + cs.accent + '30' : 'none';
                var badgeBg = (isSelected || isActive) ? cs.accent : '#21262d';
                var badgeColor = (isSelected || isActive) ? '#0d1117' : '#8b949e';
                var layerPad = layer.id === 8 ? '14px 16px' : '10px 16px';

                html += '<div class="explorer-layer-item" data-layer-id="' + layer.id + '" style="display:grid;grid-template-columns:50px 1fr 24px;align-items:center;gap:12px;padding:' + layerPad + ';background:' + bgColor + ';border-radius:8px;border:1px solid ' + borderColor + ';cursor:pointer;transition:all 0.15s ease;box-shadow:' + shadow + '">';
                html += '<div style="background:' + badgeBg + ';border-radius:6px;padding:6px;text-align:center;font-size:13px;font-weight:600;color:' + badgeColor + ';transition:all 0.15s ease">L' + layer.id + '</div>';
                html += '<div>';
                html += '<div style="font-size:14px;font-weight:500;color:' + (isSelected ? '#f0f6fc' : '#c9d1d9') + '">' + layer.name + '</div>';
                html += '<div style="font-size:11px;color:#8b949e">' + layer.osi + '</div>';
                html += '</div>';
                html += '<div style="width:8px;height:8px;border-radius:50%;background:' + (isActive ? cs.accent : 'transparent') + ';box-shadow:' + (isActive ? '0 0 8px ' + cs.accent : 'none') + '"></div>';
                html += '</div>';
            }
            html += '</div>';

            // Signal Flow Controls
            html += '<div style="margin-top:20px;padding:16px;background:#161b22;border-radius:8px;border:1px solid #21262d">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<div>';
            html += '<div style="font-size:10px;color:#8b949e;letter-spacing:0.1em">SIGNAL FLOW</div>';
            html += '<div style="font-size:13px;color:' + (explorerState.direction === 'up' ? '#3fb950' : '#58a6ff') + ';margin-top:4px">' + (explorerState.direction === 'up' ? 'BIOLOGY \u2192 SILICON' : 'SILICON \u2192 BIOLOGY') + '</div>';
            html += '</div>';
            html += '<button id="explorer-anim-btn" style="background:' + (explorerState.isAnimating ? 'rgba(248,81,73,0.1)' : 'rgba(63,185,80,0.1)') + ';border:1px solid ' + (explorerState.isAnimating ? '#f85149' : '#3fb950') + ';color:' + (explorerState.isAnimating ? '#f85149' : '#3fb950') + ';padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;font-family:inherit">' + (explorerState.isAnimating ? 'PAUSE' : 'PLAY') + '</button>';
            html += '</div></div>';

            html += '</div>'; // end left panel

            // Right Panel - Details & Attack Matrix
            html += '<div style="display:flex;flex-direction:column;gap:20px">';

            // Layer Detail Card
            html += '<div style="background:#161b22;border-radius:12px;border:1px solid #21262d;overflow:hidden;flex:' + (selectedLayerData ? 'none' : '1') + '">';
            html += '<div style="padding:16px 20px;border-bottom:1px solid #21262d;background:#0d1117">';
            html += '<h2 style="margin:0;font-size:14px;color:#8b949e;letter-spacing:0.1em">' + (selectedLayerData ? 'LAYER ' + selectedLayerData.id + ' \u2014 ' + selectedLayerData.name.toUpperCase() : 'SELECT A LAYER TO EXPLORE') + '</h2>';
            html += '</div>';

            if (selectedLayerData) {
                var catAccent = selectedLayerData.category === 'silicon' ? '#58a6ff' : selectedLayerData.category === 'gateway' ? '#f0883e' : '#3fb950';

                html += '<div style="padding:20px">';

                // Info grid
                html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">';
                html += '<div style="padding:14px;background:#0d1117;border-radius:8px;border-left:3px solid ' + catAccent + '">';
                html += '<div style="font-size:10px;color:#8b949e;letter-spacing:0.1em;margin-bottom:6px">FUNCTION</div>';
                html += '<div style="font-size:13px;color:#c9d1d9;line-height:1.5">' + selectedLayerData.description + '</div>';
                html += '</div>';
                html += '<div style="padding:14px;background:#0d1117;border-radius:8px;border-left:3px solid #8b949e">';
                html += '<div style="font-size:10px;color:#8b949e;letter-spacing:0.1em;margin-bottom:6px">OSI MAPPING</div>';
                html += '<div style="font-size:13px;color:#c9d1d9"><span style="color:#f0f6fc;font-weight:500">' + selectedLayerData.osi + '</span> Layer</div>';
                html += '<div style="font-size:11px;color:#8b949e;margin-top:8px">';
                if (selectedLayerData.category === 'silicon') html += 'Standard OSI network model';
                else if (selectedLayerData.category === 'gateway') html += 'Security perimeter control';
                else html += 'Cognitive system extension';
                html += '</div></div>';
                html += '</div>';

                // Attack vectors
                html += '<div style="font-size:11px;letter-spacing:0.15em;color:#f85149;margin-bottom:12px;display:flex;align-items:center;gap:8px"><span style="font-size:14px">\u26A0</span> ATTACK VECTORS (' + selectedLayerData.attacks.length + ')</div>';
                html += '<div style="display:flex;flex-direction:column;gap:8px">';
                for (var a = 0; a < selectedLayerData.attacks.length; a++) {
                    var attack = selectedLayerData.attacks[a];
                    var tc = tacticColors[attack.tactic] || '#8b949e';
                    var isExpanded = explorerState.selectedAttack === attack.id;
                    html += '<div class="explorer-attack-card" data-attack-id="' + attack.id + '" style="padding:12px 16px;background:' + (isExpanded ? '#21262d' : '#0d1117') + ';border-radius:8px;border:1px solid ' + (isExpanded ? '#ffffff' : '#21262d') + ';cursor:pointer;transition:all 0.15s ease">';
                    html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:' + (isExpanded ? '10px' : '0') + '">';
                    html += '<div><span style="font-size:11px;color:#8b949e;margin-right:8px">' + attack.id + '</span>';
                    html += '<span style="font-size:14px;font-weight:500;color:#f0f6fc">' + attack.name + '</span></div>';
                    html += '<span style="font-size:10px;padding:3px 8px;border-radius:4px;background:' + tc + '20;color:' + tc + ';font-weight:500;white-space:nowrap">' + attack.tactic + '</span>';
                    html += '</div>';
                    if (isExpanded) {
                        html += '<div style="font-size:13px;color:#8b949e;line-height:1.5;padding-top:10px;border-top:1px solid #21262d">' + attack.description + '</div>';
                    }
                    html += '</div>';
                }
                html += '</div>';
                html += '</div>';
            } else {
                // Welcome state
                html += '<div style="padding:30px 20px">';
                html += '<div style="text-align:center;margin-bottom:30px">';
                html += '<div style="font-size:64px;margin-bottom:16px;opacity:0.2;font-weight:300;background:linear-gradient(90deg,#58a6ff,#f0883e,#3fb950);-webkit-background-clip:text;-webkit-text-fill-color:transparent">L1-L14</div>';
                html += '<div style="color:#8b949e;margin-bottom:8px">Click on any layer to explore attack vectors</div>';
                html += '<div style="font-size:12px;color:#484f58">Each layer maps to specific threat signatures</div>';
                html += '</div>';

                // Zone overview cards
                html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px">';
                html += '<div style="padding:16px;background:rgba(88,166,255,0.05);border-radius:8px;border:1px solid rgba(88,166,255,0.2);text-align:center"><div style="font-size:24px;font-weight:600;color:#58a6ff">L1-L7</div><div style="font-size:11px;color:#8b949e;margin-top:4px">Silicon Layers</div><div style="font-size:10px;color:#484f58;margin-top:2px">OSI Model</div></div>';
                html += '<div style="padding:16px;background:rgba(240,136,62,0.08);border-radius:8px;border:1px solid rgba(240,136,62,0.3);text-align:center"><div style="font-size:24px;font-weight:600;color:#f0883e">L8</div><div style="font-size:11px;color:#8b949e;margin-top:4px">Neural Gateway</div><div style="font-size:10px;color:#484f58;margin-top:2px">NSAM Firewall</div></div>';
                html += '<div style="padding:16px;background:rgba(63,185,80,0.05);border-radius:8px;border:1px solid rgba(63,185,80,0.2);text-align:center"><div style="font-size:24px;font-weight:600;color:#3fb950">L9-L14</div><div style="font-size:11px;color:#8b949e;margin-top:4px">Biology Layers</div><div style="font-size:10px;color:#484f58;margin-top:2px">Cognitive Systems</div></div>';
                html += '</div>';

                // Tactic legend
                html += '<div style="margin-bottom:24px">';
                html += '<div style="font-size:11px;color:#8b949e;letter-spacing:0.1em;margin-bottom:12px">THREAT TACTICS</div>';
                html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">';
                var tactics = Object.keys(tacticColors);
                for (var t = 0; t < tactics.length; t++) {
                    html += '<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#0d1117;border-radius:6px">';
                    html += '<div style="width:10px;height:10px;border-radius:3px;background:' + tacticColors[tactics[t]] + '"></div>';
                    html += '<span style="font-size:11px;color:#8b949e">' + tactics[t] + '</span></div>';
                }
                html += '</div></div>';

                // Key concepts
                html += '<div>';
                html += '<div style="font-size:11px;color:#8b949e;letter-spacing:0.1em;margin-bottom:12px">KEY CONCEPTS</div>';
                html += '<div style="display:flex;flex-direction:column;gap:8px">';
                html += '<div style="padding:12px;background:#0d1117;border-radius:8px;display:flex;gap:12px;align-items:flex-start">';
                html += '<div style="font-size:16px;font-weight:600;color:#3fb950;min-width:36px">C\u209B</div>';
                html += '<div><div style="font-size:12px;color:#c9d1d9;font-weight:500">Coherence Metric</div>';
                html += '<div style="font-size:11px;color:#8b949e;margin-top:2px">Signal trust score: C\u209B = e^(\u2212(\u03C3\u00B2\u03C6 + \u03C3\u00B2\u03C4 + \u03C3\u00B2\u03B3))</div></div></div>';
                html += '<div style="padding:12px;background:#0d1117;border-radius:8px;display:flex;gap:12px;align-items:flex-start">';
                html += '<div style="font-size:14px;font-weight:600;color:#f0883e;min-width:36px">NSAM</div>';
                html += '<div><div style="font-size:12px;color:#c9d1d9;font-weight:500">Neural Signal Assurance Model</div>';
                html += '<div style="font-size:11px;color:#8b949e;margin-top:2px">Entropy-based coherence validation at L8</div></div></div>';
                html += '</div></div>';

                html += '</div>';
            }

            html += '</div>'; // end detail card

            // Signal Propagation SVG
            html += '<div style="background:#161b22;border-radius:12px;border:1px solid #21262d;padding:20px">';
            html += '<div style="font-size:11px;letter-spacing:0.15em;color:#8b949e;margin-bottom:16px">SIGNAL PROPAGATION</div>';
            html += '<svg viewBox="0 0 700 200" style="width:100%;height:auto">';
            html += '<defs>';
            html += '<linearGradient id="siliconGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#58a6ff"/><stop offset="100%" stop-color="#1f6feb"/></linearGradient>';
            html += '<linearGradient id="bioGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#3fb950"/><stop offset="100%" stop-color="#238636"/></linearGradient>';
            html += '<filter id="svgGlow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>';
            html += '</defs>';

            // Silicon zone
            html += '<rect x="20" y="20" width="280" height="160" fill="rgba(88,166,255,0.05)" rx="8" stroke="#21262d"/>';
            html += '<text x="35" y="45" fill="#58a6ff" font-size="10" font-family="Inter,sans-serif">SILICON L1-L7</text>';
            for (var s = 1; s <= 7; s++) {
                var sActive = signalLayer === s;
                var sSel = explorerState.activeLayer === s;
                var sx = 35 + (s-1) * 36;
                html += '<rect class="explorer-svg-layer" data-layer-id="' + s + '" x="' + sx + '" y="60" width="32" height="100" rx="4" fill="' + (sActive ? 'url(#siliconGrad)' : sSel ? 'rgba(88,166,255,0.3)' : '#21262d') + '" stroke="' + (sSel ? '#ffffff' : sActive ? '#58a6ff' : '#30363d') + '" stroke-width="' + (sSel ? 2 : 1) + '"' + (sActive ? ' filter="url(#svgGlow)"' : '') + ' style="cursor:pointer"/>';
                html += '<text x="' + (51 + (s-1)*36) + '" y="115" fill="' + (sActive||sSel ? '#fff' : '#8b949e') + '" font-size="11" font-family="Inter,sans-serif" text-anchor="middle" style="pointer-events:none">L' + s + '</text>';
            }

            // Gateway
            var gSel = explorerState.activeLayer === 8;
            html += '<rect class="explorer-svg-layer" data-layer-id="8" x="320" y="60" width="60" height="100" rx="8" fill="' + (signalLayer===8 ? '#f0883e' : gSel ? 'rgba(240,136,62,0.4)' : 'rgba(240,136,62,0.2)') + '" stroke="' + (gSel ? '#ffffff' : '#f0883e') + '" stroke-width="' + (gSel ? 2 : signalLayer===8 ? 2 : 1) + '"' + (signalLayer===8 ? ' filter="url(#svgGlow)"' : '') + ' style="cursor:pointer"/>';
            html += '<text x="350" y="100" fill="' + (signalLayer===8 ? '#0d1117' : '#f0883e') + '" font-size="12" font-family="Inter,sans-serif" text-anchor="middle" font-weight="600" style="pointer-events:none">L8</text>';
            html += '<text x="350" y="120" fill="' + (signalLayer===8 ? '#0d1117' : '#8b949e') + '" font-size="8" font-family="Inter,sans-serif" text-anchor="middle" style="pointer-events:none">GATEWAY</text>';
            html += '<text x="350" y="145" fill="' + (signalLayer===8 ? '#0d1117' : '#8b949e') + '" font-size="8" font-family="Inter,sans-serif" text-anchor="middle" style="pointer-events:none">NSAM</text>';

            // Biology zone
            html += '<rect x="400" y="20" width="280" height="160" fill="rgba(63,185,80,0.05)" rx="8" stroke="#21262d"/>';
            html += '<text x="415" y="45" fill="#3fb950" font-size="10" font-family="Inter,sans-serif">BIOLOGY L9-L14</text>';
            for (var b = 9; b <= 14; b++) {
                var bActive = signalLayer === b;
                var bSel = explorerState.activeLayer === b;
                var bx = 415 + (b-9) * 42;
                html += '<rect class="explorer-svg-layer" data-layer-id="' + b + '" x="' + bx + '" y="60" width="38" height="100" rx="4" fill="' + (bActive ? 'url(#bioGrad)' : bSel ? 'rgba(63,185,80,0.3)' : '#21262d') + '" stroke="' + (bSel ? '#ffffff' : bActive ? '#3fb950' : '#30363d') + '" stroke-width="' + (bSel ? 2 : 1) + '"' + (bActive ? ' filter="url(#svgGlow)"' : '') + ' style="cursor:pointer"/>';
                html += '<text x="' + (434 + (b-9)*42) + '" y="115" fill="' + (bActive||bSel ? '#fff' : '#8b949e') + '" font-size="11" font-family="Inter,sans-serif" text-anchor="middle" style="pointer-events:none">L' + b + '</text>';
            }

            // Flow arrows
            html += '<path d="M 295 110 L 315 110" stroke="#f0883e" stroke-width="2" opacity="0.5"/>';
            html += '<path d="M 385 110 L 405 110" stroke="#f0883e" stroke-width="2" opacity="0.5"/>';
            html += '</svg>';
            html += '</div>';

            html += '</div>'; // end right panel

            // Footer
            html += '</main>';
            html += '<footer style="padding:20px 40px;border-top:1px solid #21262d;text-align:center;margin-top:40px;position:relative;z-index:1">';
            html += '<p style="margin:0;font-size:12px;color:#8b949e">ONI Framework \u2014 Open Neurosecurity Interoperability \u2014 <span style="color:#f0883e">"Only life\'s most important connections deserve the most thought"</span></p>';
            html += '</footer>';

            root.innerHTML = html;

            // Attach event listeners
            root.querySelectorAll('.explorer-layer-item').forEach(function(el) {
                el.addEventListener('click', function() {
                    var id = parseInt(this.getAttribute('data-layer-id'));
                    explorerState.activeLayer = explorerState.activeLayer === id ? null : id;
                    explorerState.selectedAttack = null;
                    renderExplorer();
                });
            });

            root.querySelectorAll('.explorer-attack-card').forEach(function(el) {
                el.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var id = this.getAttribute('data-attack-id');
                    explorerState.selectedAttack = explorerState.selectedAttack === id ? null : id;
                    renderExplorer();
                });
            });

            root.querySelectorAll('.explorer-svg-layer').forEach(function(el) {
                el.addEventListener('click', function() {
                    var id = parseInt(this.getAttribute('data-layer-id'));
                    explorerState.activeLayer = explorerState.activeLayer === id ? null : id;
                    explorerState.selectedAttack = null;
                    renderExplorer();
                });
            });

            var animBtn = document.getElementById('explorer-anim-btn');
            if (animBtn) {
                animBtn.addEventListener('click', function() {
                    explorerState.isAnimating = !explorerState.isAnimating;
                    if (explorerState.isAnimating) {
                        startAnimation();
                    } else {
                        if (animInterval) clearInterval(animInterval);
                    }
                    renderExplorer();
                });
            }
        }

        renderExplorer();
        startAnimation();
    }

    // --- Explorer Wave Background ---
    function initExplorerWaveBackground() {
        var canvas = document.getElementById('explorer-wave-canvas');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        var width, height;
        var time = 0;
        var lineCount = 12;
        var color = '88, 166, 255';
        var speed = 0.008;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        function drawWave(yOffset, amplitude, frequency, phase, opacity) {
            ctx.beginPath();
            ctx.moveTo(0, height / 2 + yOffset);
            for (var x = 0; x <= width; x += 3) {
                var y = height / 2 + yOffset +
                    Math.sin(x * frequency + phase) * amplitude +
                    Math.sin(x * frequency * 0.5 + phase * 1.3) * (amplitude * 0.5);
                ctx.lineTo(x, y);
            }
            ctx.strokeStyle = 'rgba(' + color + ', ' + opacity + ')';
            ctx.lineWidth = 1.5;
            ctx.stroke();
        }

        function animate() {
            if (!document.body.classList.contains('view-explorer')) {
                requestAnimationFrame(animate);
                return;
            }
            ctx.fillStyle = '#0a0f1a';
            ctx.fillRect(0, 0, width, height);
            for (var i = 0; i < lineCount; i++) {
                var yOffset = (i - lineCount / 2) * 60;
                var amplitude = 20 + Math.sin(time + i * 0.5) * 10;
                var frequency = 0.003 + i * 0.0002;
                var phase = time * (1 + i * 0.1);
                var opacity = 0.15 + (1 - Math.abs(i - lineCount / 2) / (lineCount / 2)) * 0.2;
                drawWave(yOffset, amplitude, frequency, phase, opacity);
            }
            time += speed;
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resize);
        resize();
        animate();
    }

    // --- Header auto-hide ---
    (function() {
        var header = document.getElementById('header');
        var revealBar = document.getElementById('header-reveal');
        var scenarioBar = document.getElementById('scenario-bar');
        var hideTimer = null;
        var headerVisible = true;
        var active = false; // only start auto-hiding after a view is launched

        function collapseHeader() {
            if (!headerVisible || !active) return;
            if (document.body.classList.contains('view-landing')) return;
            headerVisible = false;
            header.classList.add('header-collapsed');
            revealBar.classList.add('visible');
            if (scenarioBar) scenarioBar.style.top = '8px';
        }

        function showHeader() {
            headerVisible = true;
            header.classList.remove('header-collapsed');
            revealBar.classList.remove('visible');
            if (active && scenarioBar) scenarioBar.style.top = header.offsetHeight + 'px';
            resetHideTimer();
        }
        window.showHeader = showHeader;

        function resetHideTimer() {
            clearTimeout(hideTimer);
            if (active) {
                hideTimer = setTimeout(collapseHeader, 4000);
            }
        }

        // Hover on header keeps it open
        header.addEventListener('mouseenter', function() {
            clearTimeout(hideTimer);
            if (!headerVisible) showHeader();
        });
        header.addEventListener('mouseleave', function() {
            resetHideTimer();
        });

        // Hover on reveal bar shows header
        revealBar.addEventListener('mouseenter', function() {
            showHeader();
        });

        // Moving mouse near top of screen shows header
        document.addEventListener('mousemove', function(e) {
            if (e.clientY < 12 && !headerVisible && active) {
                showHeader();
            }
        });

        // Header starts visible when a view is launched, then auto-hides after 4s
        var origLaunchView = window.launchView;
        window.launchView = function(view) {
            origLaunchView(view);
            active = true;
            showHeader();
        };
        var origLaunchScenario = window.launchScenario;
        window.launchScenario = function() {
            origLaunchScenario();
            active = true;
            showHeader();
        };
    })();
    </script>
</body>
</html>
